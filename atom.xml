<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[function Blog() {};]]></title>
  <link href="http://lunchub.github.io/atom.xml" rel="self"/>
  <link href="http://lunchub.github.io/"/>
  <updated>2013-09-17T22:40:10+09:00</updated>
  <id>http://lunchub.github.io/</id>
  <author>
    <name><![CDATA[Daisuke Masuyama]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Octopressで記事の生成を高速化する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/09/13/how-to-improve-generating-a-post-faster-on-octopress/"/>
    <updated>2013-09-13T21:45:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/09/13/how-to-improve-generating-a-post-faster-on-octopress</id>
    <content type="html"><![CDATA[<h2>Issues</h2>

<p><code>Octopress</code>で新しい記事を作成したり、既存の記事の編集の際に、<code>rake preview</code>や<code>rake generate</code>の実行に非常に時間が
かかってしまい、編集の効率が悪い。</p>

<h3>Factor</h3>

<p><code>Octopress</code>は、<code>preview</code>や<code>generate</code>の際、<code>source/_posts</code>配下にある記事を全て静的なHTMLへと再生成してしまうため。
記事の数が増えるほど、生成にかかる時間が増してしまうため。</p>

<h2>Solution</h2>

<ul>
<li><code>rake isolate[filename]</code>と、<code>rake integrate</code>を使用する</li>
</ul>


<h2>How to</h2>

<h3><code>rake isolate[filename]</code>と、<code>rake integrate</code>を使用する</h3>

<h4>rake isolate[filename]</h4>

<p><code>rake isolate[filename]</code>は、<code>filename</code>に指定したファイル名と一致しない記事ファイルを、
全て<code>source/_stash</code>に退避してくれる。これにより、<code>preview</code>や<code>generate</code>の際、生成のために参照する記事数が
圧倒的に少なくなるため、生成に要する時間が短縮される。</p>

<p>この<code>filename</code>に指定するファイル名は部分一致が可能なので、ファイル名をフルで指定する必要はない。
例えばこの記事のファイル名は<code>2013-09-13-how-to-improve-generating-a-post-faster-on-octopress.markdown</code>なので、
<code>faster-on-octopress</code>とでも指定しておけば問題ない。</p>

<h4>rake integrate</h4>

<p><code>rake integrate</code>は前述の<code>rake isolate[filename]</code>で退避したファイルを全て<code>source/_posts</code>に戻してくれる。</p>

<h2>Conclusion</h2>

<p>新規記事の作成や、記事の更新の手順は以下の通り。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>新規記事 or 更新対象記事 のファイル名（filename）を確認する。
</span><span class='line'>↓
</span><span class='line'>rake isolate[filename]
</span><span class='line'>↓
</span><span class='line'>rake preview や rake generate を使用しながら対象記事を編集する
</span><span class='line'>↓
</span><span class='line'>rake integrate
</span><span class='line'>↓
</span><span class='line'>rake gen_deploy</span></code></pre></td></tr></table></div></figure>


<p>この方法はあくまで「新規記事の作成」と「記事の更新」を高速化するものなので、
記事の生成処理自体が早くなるわけではなく、最終的な<code>rake gen_deploy</code>は早くならないのが微妙なところ。</p>

<p>一応別の記事で解説予定の、「高速化パッチの当たったRuby」を使用することで生成速度はだいぶ改善される。</p>

<h2>Mutter</h2>

<p>記事のタイムスタンプをチェックするとかで、この回避策使わなくていいようにできないのかなあ・・<br/>
差分がなければスルーして欲しいところ。</p>

<h2>References</h2>

<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zshでrakeコマンドを実行するとエラーになる]]></title>
    <link href="http://lunchub.github.io/blog/2013/09/13/how-to-avoid-rake-command-error-with-zsh/"/>
    <updated>2013-09-13T20:18:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/09/13/how-to-avoid-rake-command-error-with-zsh</id>
    <content type="html"><![CDATA[<h2>Issues</h2>

<p><code>zsh</code>で<code>rake</code>コマンドを実行すると以下のようなエラーが表示される。</p>

<figure class='code'><figcaption><span>zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake some_task:create<span class="o">[</span>some_param<span class="o">]</span>
</span><span class='line'>zsh: no matches found: some_task:create<span class="o">[</span>some_param<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Factor</h3>

<p><code>zsh</code>では<code>[]</code>がワイルドカード扱いとなってしまうため。
上記の例だと次のような意味になる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>rake some_task:creates
</span><span class='line'>rake some_task:createo
</span><span class='line'>rake some_task:createm
</span><span class='line'>rake some_task:createe
</span><span class='line'>rake some_task:create_
</span><span class='line'>rake some_task:createp
</span><span class='line'>rake some_task:createa
</span><span class='line'>rake some_task:creater
</span><span class='line'>rake some_task:createa
</span><span class='line'>rake some_task:createm
</span></code></pre></td></tr></table></div></figure>


<h2>Solution</h2>

<ul>
<li><code>[]</code>の前にバックスラッシュ<code>\</code>を置くことで回避する</li>
<li>コマンド自体をシングルクォートで囲む</li>
</ul>


<h2>How to</h2>

<h3><code>[]</code>の前にバックスラッシュ<code>\</code>を置くことで回避する</h3>

<figure class='code'><figcaption><span>zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake some_task:create<span class="se">\[</span>some_param<span class="se">\]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>コマンド自体をシングルクォートで囲む</h3>

<figure class='code'><figcaption><span>zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake <span class="s1">&#39;some_task:create[some_param]&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] モデルを登録する際に、他のモデルを同時に登録する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/08/30/how-to-save-model-together-with-related-model/"/>
    <updated>2013-08-30T22:47:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/08/30/how-to-save-model-together-with-related-model</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p>モデルAの登録を行った際に、同時にモデルBの登録も行いたい。</p>

<p>例：<br/>
モデル「Task」とモデル「Notice」がある前提で、
「Task」を追加した際に、「Notice」に「Task」が追加されたという内容を追加したい。</p>

<h2>Solution</h2>

<ul>
<li><code>ActiveRecord Callbacks</code>を使う

<ul>
<li>今回使用したのは<code>after_create</code></li>
</ul>
</li>
</ul>


<h2>How to</h2>

<h3><code>ActiveRecord Callbacks</code>を使う</h3>

<p><code>ActiveRecord</code>には豊富な<code>コールバック関数</code>が用意されていて、
モデルの<code>登録</code> <code>更新</code> <code>検証</code> <code>削除</code>（厳密にはその前後）といったタイミングにおいて実行されるようになっている。</p>

<p>そこで、<code>コールバック関数</code>に実行したい処理を登録しておくと、
適切なタイミングで、処理を実行させることができる。</p>

<p>また、実行したい処理は、複数登録することもできる。
その場合、実行順序がトリッキーな感じなので参考リンクを参照。</p>

<p>具体的には以下のコードで、「Task」を登録した際に、「Notice」に「Task」が追加されたという内容を登録できる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">after_create</span> <span class="ss">:create_notice</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_notice</span>
</span><span class='line'>    <span class="n">notice</span> <span class="o">=</span> <span class="no">Notice</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">notice</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;タスクを追加しました。&#39;</span>
</span><span class='line'>    <span class="n">notice</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Doubt</h3>

<ul>
<li><code>:dependent =&gt; :destroy</code>もこの仕組み使っているのだろうか</li>
</ul>


<h2>References</h2>

<ul>
<li><a href="http://guides.rubyonrails.org/active_record_callbacks.html">[RailsGuides] Active Record Callbacks</a></li>
<li><a href="http://techracho.bpsinc.jp/baba/2013_08_19/12657">Rails 4でcallback(before/after/around action)の実行順序おさらい</a></li>
</ul>


<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] formtasticでSELECTタグを生成する際、SELECTタグの先頭に空行を自動挿入させない方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/08/26/without-blank-fields-in-select-tag-on-formtastic/"/>
    <updated>2013-08-26T20:12:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/08/26/without-blank-fields-in-select-tag-on-formtastic</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  formtastic (2.2.1)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><code>formtastic</code>を使用してSELECTタグを生成する際に、SELECTタグの先頭に空行を自動挿入させたくない。</p>

<h2>Solution</h2>

<ul>
<li><code>:include_blank</code>オプションを使う</li>
</ul>


<h2>How to</h2>

<h3><code>:include_blank</code>オプションを使う</h3>

<p>こんな感じにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>= f.input :author, :as =&gt; :select, :include_blank =&gt; false</span></code></pre></td></tr></table></div></figure>


<p>これがREADMEに載っていない理由は謎。</p>

<h2>References</h2>

<p><a href="https://github.com/justinfrench/formtastic/blob/master/lib/formtastic/helpers/input_helper.rb">[GitHub] formtastic source</a></p>

<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] activeadmin上でhas_many resourcesのフォーム要素を動的に追加、削除するための機能を実装する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/08/04/how-to-impletemt-add-and-remove-feature-for-has_many-resources-in-active-admin-on-rails/"/>
    <updated>2013-08-04T15:17:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/08/04/how-to-impletemt-add-and-remove-feature-for-has_many-resources-in-active-admin-on-rails</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  activeadmin (0.6.0)
</span><span class='line'>  formtastic (2.2.1)
</span><span class='line'>  cocoon (1.2.0)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p>activeadminで<code>has_many resources</code>のフォームに対して、動的に子モデルのフォーム要素の追加や削除を行う機能を実装したい。</p>

<h2>Solution</h2>

<p>現状確認している方法は以下の3通り。</p>

<ul>
<li>activeadminの標準機能（<code>form_builder</code>）を使う

<ul>
<li>[OK] 動的なフォーム要素の追加</li>
<li>[NG] 動的なフォーム要素の削除

<ul>
<li>動的に追加したフォーム要素にのみ、削除ボタンが現れる

<ul>
<li>既に登録済みのレコードを削除できない

<ul>
<li><strong>削除機能は自分で実装する必要がある</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>formtastic</code>に自作のhelper関数を組み合わせて使う

<ul>
<li>[OK] 動的なフォーム要素の追加</li>
<li>[OK] 動的なフォーム要素の削除</li>
</ul>
</li>
<li><code>cocoon</code>を使う

<ul>
<li>[OK] 動的なフォーム要素の追加</li>
<li>[OK] 動的なフォーム要素の削除</li>
</ul>
</li>
</ul>


<h2>How to</h2>

<h3>モデル側の準備</h3>

<p>何れの方法で実装するにしても、親モデル側に以下の記述をして置く必要がある。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:tasks_attributes</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:tasks</span>
</span><span class='line'>  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:tasks</span><span class="p">,</span>  <span class="ss">:reject_if</span> <span class="o">=&gt;</span> <span class="ss">:all_blank</span><span class="p">,</span>  <span class="ss">:allow_destroy</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>:accepts_nested_attributes_for</code></h4>

<p>1つのフォームの中で、親モデルと<code>has_many</code>で関連付けられた、子モデルの同時編集を可能にするための機能。</p>

<h4><code>:reject_if</code></h4>

<p>ここで指定した条件にマッチすれば、子モデルの保存をスルーさせることができる機能。</p>

<p>ここでは<code>:all_blank</code>を指定しているので、全ての項目が未編集のままフォームが送信された場合は、
子モデルの保存が行われない。</p>

<p><code>:all_blank</code>の他に、<code>lamda</code>や<code>proc</code>、<code>privateメソッド</code>を指定することができる。</p>

<p>状況としては、動的に子モデルのフォーム要素を追加したが、やっぱりいらないやということで、
未編集のままフォームを送信した場合等に、空のデータのまま子モデルが保存されるのを防ぐことができる。</p>

<h4><code>:allow_destroy</code></h4>

<p>1つのフォームで親モデルと一緒に保存できるようになったはいいけど、削除だってしたいよという場合に使う機能。</p>

<p><code>:allow_destroy</code>を有効にすると、<code>_destroy</code>パラメータを子モデルと一緒に渡すことで、
削除してくれるようになる。</p>

<p>例えばチェックボックスに<code>project[tasks_attributes][0][_destroy]</code>といった<code>name属性</code>を割り当てて、
チェックボックスにチェックが入った状態で送信すると、tasks_attributesの0番目の要素が削除される。</p>

<h4><code>:attr_accessible</code></h4>

<p><code>:accepts_nested_attributes_for</code>を指定すると、フォームの中で子モデルの<code>name属性</code>は<code>xxx_attributes</code>（xxxは子モデルの名前）という形で自動的に割り振られる。</p>

<p>しかし、せっかく割り振られた<code>name属性</code>にアクセスできないと、値の変更を行うことができないため、
予め<code>:attr_accessible</code>にキーを設定しておく。</p>

<h3>activeadminの標準機能（<code>form_builder</code>）を使う</h3>

<p><code>activeadmin</code>にも標準で動的に要素を追加する機能が備わっている。
しかし、動的に削除する機能は、動的に追加した要素にのみ表示されるようになっており、
一度保存したデータに対しては削除機能は提供されないので、
その部分は自分で実装する必要がある。</p>

<p>この削除機能のやっつけ感が否めない・・・
空データの登録をさせないにも中途半端だし、そもそもそれなら<code>:reject_if</code>があるし・・</p>

<p>ということで、削除機能（チェックボックス）付きの実装は以下の通り。</p>

<figure class='code'><figcaption><span>app/admin/projects.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">activeadmin</span><span class="o">.</span><span class="n">register</span> <span class="no">Project</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">form</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">has_many</span> <span class="ss">:tasks</span> <span class="k">do</span> <span class="o">|</span><span class="n">att</span><span class="o">|</span>
</span><span class='line'>      <span class="n">att</span><span class="o">.</span><span class="n">input</span> <span class="ss">:_destroy</span><span class="p">,</span>  <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:boolean</span><span class="p">,</span>  <span class="ss">:label</span> <span class="o">=&gt;</span> <span class="s2">&quot;Destroy?&quot;</span>
</span><span class='line'>      <span class="n">att</span><span class="o">.</span><span class="n">input</span> <span class="ss">:task</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">actions</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>この実装だと動的にフォーム要素は消えないので、そこは<code>jQuery</code>なりでゴリゴリ実装する必要がある。
この後紹介するRailsCastsのヘルパー関数を自作して埋め込むのも有りだと思う。</p>

<h4>activeadminの実装を見てみる</h4>

<p>子モデルの1レコードずつ、フォーム要素を構築する処理の中で、<code>has_many_form.object.new_record?</code>の場合のみ、
削除用のJSが仕込まれていることがわかる。やっている内容は当該レコードをラップしているHTMLを<code>remove()</code>するだけ。</p>

<p>動的にフォーム要素を追加するJSを、<code>js_for_has_many</code>から呼び出して、バッファの最後に追加していることがわかる。</p>

<p>これってレコード毎に削除用フラグを管理する<code>hidden</code>タグを埋め込んでおいて、
削除用JSにフラグの<code>value</code>を<code>true</code>にする処理追加すればいいんじゃないのかなぁ・・</p>

<figure class='code'><figcaption><span>vendor/bundle/ruby/1.9.1/gems/activeadmin-0.6.0/lib/active_admin/form_builder.rb#L.44, L.172</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">has_many</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Add Delete Links</span>
</span><span class='line'>  <span class="n">form_block</span> <span class="o">=</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">has_many_form</span><span class="o">|</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">has_many_form</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">new_record?</span>
</span><span class='line'>      <span class="n">contents</span> <span class="o">+=</span> <span class="n">template</span><span class="o">.</span><span class="n">content_tag</span><span class="p">(</span><span class="ss">:li</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">template</span><span class="o">.</span><span class="n">link_to</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;active_admin.has_many_delete&#39;</span><span class="p">),</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="ss">:onclick</span> <span class="o">=&gt;</span> <span class="s2">&quot;$(this).closest(&#39;.has_many_fields&#39;).remove(); return false;&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;button&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">form_buffers</span><span class="o">.</span><span class="n">last</span> <span class="o">&lt;&lt;</span> <span class="n">with_new_form_buffer</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">template</span><span class="o">.</span><span class="n">content_tag</span> <span class="ss">:div</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;has_many </span><span class="si">#{</span><span class="n">association</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">form_buffers</span><span class="o">.</span><span class="n">last</span> <span class="o">&lt;&lt;</span> <span class="n">js_for_has_many</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">form_block</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Capture the ADD JS</span>
</span><span class='line'><span class="k">def</span> <span class="nf">js_for_has_many</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">form_block</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">onclick</span> <span class="o">=</span> <span class="s2">&quot;$(this).before(&#39;</span><span class="si">#{</span><span class="n">js</span><span class="si">}</span><span class="s2">&#39;.replace(/</span><span class="si">#{</span><span class="n">placeholder</span><span class="si">}</span><span class="s2">/g, new Date().getTime())); return false;&quot;</span>
</span><span class='line'>  <span class="n">text</span>    <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span> <span class="s1">&#39;active_admin.has_many_new&#39;</span><span class="p">,</span> <span class="ss">:model</span> <span class="o">=&gt;</span> <span class="n">assoc_name</span><span class="o">.</span><span class="n">human</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">template</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="ss">:onclick</span> <span class="o">=&gt;</span> <span class="n">onclick</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;button&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">html_safe</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>formtastic</code>に自作のhelper関数を組み合わせて使う</h3>

<p>helper関数の作成はRailsCastsと同じもので大丈夫なので、記事下部の<code>References</code>を参照してください。</p>

<p>後述の<code>cocoon</code>との違いは関数名の違いだけなので、ソースは省略します。</p>

<h3><code>cocoon</code>を使う</h3>

<p><code>cocoon</code>は、<code>Railsのデフォルトのフォームビルダー</code>, <code>formtastic</code>, <code>simpleform</code>に対応しています。
前述の自作ヘルパー関数と比べて、<code>gem</code>をインストールするだけで使えるので簡単です。</p>

<p><a href="http://lunchub.github.io/blog/2013/08/01/hamari-on-starting-to-use-cocoon-gem/">cocoon導入の際ハマった内容も記事</a>にしてあるので、よければ参考にしてください。</p>

<p><code>cocoon</code>を使った実装は以下の通り。</p>

<figure class='code'><figcaption><span>app/views/admin/projects/_form.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">semantic_form_for</span> <span class="o">[</span><span class="ss">:admin</span><span class="p">,</span>  <span class="vi">@work</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">inputs</span> <span class="s2">&quot;&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">.</span><span class="n">tasks_fields</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">semantic_fields_for</span> <span class="ss">:tasks</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>        <span class="o">=</span> <span class="n">render</span> <span class="s1">&#39;task_fields&#39;</span><span class="p">,</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">task</span>
</span><span class='line'>      <span class="o">.</span><span class="n">links</span>
</span><span class='line'>        <span class="o">=</span> <span class="n">link_to_add_association</span> <span class="s1">&#39;add task&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="ss">:tasks</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">actions</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">action</span> <span class="ss">:submit</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/views/admin/projects/_task_fields.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">nested</span><span class="o">-</span><span class="n">fields</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">inputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">input</span> <span class="ss">:task</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">link_to_remove_association</span> <span class="s2">&quot;remove task&quot;</span><span class="p">,</span> <span class="n">f</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>cocoon</code>を導入すると、<code>link_to_add_association</code>と<code>link_to_remove_association</code>関数が使えるようになります。
<code>formtastic</code> + 自作ヘルパー関数との違いは関数名だけで、引数の使い方も全く同じです。
<code>link_to_add_association</code>が<code>link_to_add_fields</code>に、
<code>link_to_remove_association</code>が<code>link_to_remove_fields</code>に対応しています。</p>

<p><code>cocoon</code>自体がRailsCastsの内容を参考にしているのでしょうね。</p>

<h2>Conclusion</h2>

<p>今のところ3番目の<code>cocoon</code>を使った実装が一番簡単じゃないかなーと思います。
<code>activeadmin</code>は<code>has_many</code>を呼ぶと勝手に、動的なフォーム要素の追加ボタンを差しこんでくれるけど、
削除機能はイマイチ君・・・</p>

<p><code>activeadmin</code>だけで完結するようになれば良いのだけど・・・</p>

<h2>References</h2>

<ul>
<li><a href="http://guides.rubyonrails.org/form_helpers.html#building-complex-forms">[RailsGuides] Building Complex Forms</a></li>
<li><a href="http://railscasts.com/episodes/196-nested-model-form-part-1">[RailsCasts] Nested Model Form Part 1</a></li>
<li><a href="http://railscasts.com/episodes/197-nested-model-form-part-2">[RailsCasts] Nested Model Form Part 2</a></li>
<li><a href="http://kray.jp/blog/has-many-through-nested-object-forms/">[Rails] Nested Object Forms を使って多対多の関係をスマートに編集 </a></li>
<li><a href="http://o.inchiki.jp/obbr/81">Railsでネストしたモデルをまとめて受け取って保存する</a></li>
<li><a href="https://github.com/nathanvda/cocoon">[GitHub] cocoon</a></li>
</ul>


<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] ActiveAdmin + cocoon を使い始めた際にハマったこと]]></title>
    <link href="http://lunchub.github.io/blog/2013/08/01/hamari-on-starting-to-use-cocoon-gem/"/>
    <updated>2013-08-01T21:25:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/08/01/hamari-on-starting-to-use-cocoon-gem</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  activeadmin (0.6.0)
</span><span class='line'>  formtastic (2.2.1)
</span><span class='line'>  cocoon (1.2.0)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<ul>
<li><p><code>Missing partial</code> エラー</p></li>
<li><p><code>undefined local variable or method</code> エラー</p></li>
<li><p><code>link_to_add_association</code>の永久ループ</p></li>
<li><p>show画面やedit画面にアップロードした画像を表示させたい</p>

<ul>
<li>アップロードできても確認ができないとねえ・・</li>
<li>これは<code>cocoon</code>というより<code>formtastic</code>の使い方の問題かな</li>
</ul>
</li>
</ul>


<h2>Solution &amp; How to</h2>

<h3>Missing partial エラー</h3>

<h4>partialに分割する必要がある</h4>

<p><code>render_association</code>で呼び出すため。</p>

<p><code>link_to_add_association -&gt; render_association</code></p>

<figure class='code'><figcaption><span>vendor/bundle/ruby/1.9.1/gems/cocoon-1.2.0/lib/cocoon/view_helpers.rb#L.34</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">render_association</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">new_object</span><span class="p">,</span> <span class="n">render_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">custom_partial</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="n">partial</span> <span class="o">=</span> <span class="n">get_partial_path</span><span class="p">(</span><span class="n">custom_partial</span><span class="p">,</span> <span class="n">association</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>partialの名前に注意（単数形であること）</h4>

<p><code>get_partial_path</code>が単数系を期待しているため。</p>

<p><code>link_to_add_association -&gt; render_association -&gt; get_partial_path</code></p>

<figure class='code'><figcaption><span>vendor/bundle/ruby/1.9.1/gems/cocoon-1.2.0/lib/cocoon/view_helpers.rb#L.98</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">get_partial_path</span><span class="p">(</span><span class="n">partial</span><span class="p">,</span> <span class="n">association</span><span class="p">)</span>
</span><span class='line'>  <span class="n">partial</span> <span class="p">?</span> <span class="n">partial</span> <span class="p">:</span> <span class="n">association</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">singularize</span> <span class="o">+</span> <span class="s2">&quot;_fields&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>undefined local variable or method エラー</h3>

<p><code>link_to_add_association</code>と同じパーシャルを使うので、<code>link_to_add_association</code>の引数と同じ名前のローカル変数を割り当てなくてはいけない。</p>

<p>当然パーシャル側の変数も合わせる。</p>

<figure class='code'><figcaption><span>_form.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nc">.attachments_fields</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">semantic_fields_for</span> <span class="ss">:attachments</span> <span class="k">do</span> <span class="o">|</span><span class="n">att</span><span class="o">|</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;attachment_fields&#39;</span><span class="p">,</span>  <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">att</span> <span class="c1"># attを f に割り当てる</span>
</span><span class='line'>  <span class="nc">.links</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to_add_association</span> <span class="s1">&#39;add image&#39;</span><span class="p">,</span>  <span class="n">f</span><span class="p">,</span>  <span class="ss">:attachments</span> <span class="c1"># f を割り当てる</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>_attachment_fields.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nc">.nested-fields</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">inputs</span> <span class="k">do</span> <span class="c1"># f に固定する</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">input</span> <span class="ss">:attachment</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:file</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to_remove_association</span> <span class="s2">&quot;remove image&quot;</span><span class="p">,</span> <span class="n">f</span>
</span></code></pre></td></tr></table></div></figure>


<h3>link_to_add_associationの永久ループ</h3>

<p><code>link_to_add_association</code>の置き場所がまずかった。</p>

<p><code>f.semantic_fields_for</code>と同じ階層にいなくてはいけない。</p>

<figure class='code'><figcaption><span>NG pattern</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">semantic_fields_for</span> <span class="ss">:attachments</span> <span class="k">do</span> <span class="o">|</span><span class="n">att</span><span class="o">|</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;attachment_fields&#39;</span><span class="p">,</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">att</span>
</span><span class='line'>    <span class="nc">.links</span>
</span><span class='line'>      <span class="p">=</span> <span class="n">link_to_add_association</span> <span class="s1">&#39;add image&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="ss">:attachments</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>OK pattern</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">semantic_fields_for</span> <span class="ss">:attachments</span> <span class="k">do</span> <span class="o">|</span><span class="n">att</span><span class="o">|</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;attachment_fields&#39;</span><span class="p">,</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">att</span>
</span><span class='line'>  <span class="nc">.links</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to_add_association</span> <span class="s1">&#39;add image&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="ss">:attachments</span>
</span></code></pre></td></tr></table></div></figure>


<h3>show画面やedit画面にアップロードした画像を表示させたい</h3>

<h4>show画面の場合</h4>

<p><code>image_tag</code>を使った。</p>

<figure class='code'><figcaption><span>app/admin/works.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveAdmin</span><span class="o">.</span><span class="n">register</span> <span class="no">Work</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">show</span> <span class="k">do</span> <span class="o">|</span><span class="n">work</span><span class="o">|</span>
</span><span class='line'>    <span class="n">div</span> <span class="n">work</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>    <span class="n">work</span><span class="o">.</span><span class="n">attachments</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">att</span><span class="o">|</span>
</span><span class='line'>      <span class="n">div</span> <span class="n">image_tag</span> <span class="n">att</span><span class="o">.</span><span class="n">attachment_url</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>edit画面の場合</h4>

<p><code>formtastic</code>の領域なので、<code>template_tag</code>を使った。</p>

<figure class='code'><figcaption><span>app/views/admin/works/_attachment_fields.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">inputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">input</span> <span class="ss">:attachment</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:file</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">image_tag</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">attachment_url</span><span class="o">.</span><span class="n">presence</span> <span class="o">||</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to_remove_association</span> <span class="s2">&quot;remove image&quot;</span><span class="p">,</span> <span class="n">f</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Mutter</h2>

<p>なんか・・<code>link_to_add_association</code>に依存しすぎな気がする・・</p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/nathanvda/cocoon">[GitHub] cocoon</a></li>
</ul>


<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Amazon S3のバケット名に"."ドットを含めるとハマる]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/29/hamari-on-s3-bucket-name-with-dots/"/>
    <updated>2013-07-29T17:05:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/29/hamari-on-s3-bucket-name-with-dots</id>
    <content type="html"><![CDATA[<h2>Precondition</h2>

<ul>
<li><a href="http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3/">CarrierWaveでアップロード先をAmazon S3に設定する方法</a></li>
<li><a href="http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3/">CarrierWaveからAmazon S3に画像アップロードできない</a></li>
</ul>


<h2>Issues</h2>

<p><code>carrierwave</code> + <code>fog</code>で<code>Amazon S3</code>に画像をアップロードできようになったのはいいものの、<br/>
いざ画面に<code>Amazon S3</code>上の画像を表示させようとすると、<br/>
画像が表示されない。</p>

<h3>Factor</h3>

<p>バケット名にドット<code>.</code>が含まれていることで、SSLエラーが発生している。<br/>
<code>Amazon S3</code>のSSL証明書がワイルドカード<code>*.s3-ap-northeast-1.amazonaws.com</code>だから。<br/>
これはレベル3ドメインまでの範囲で、ワイルドカードを使っていいよということなので、<br/>
<code>mysite.com.s3-ap-northeast-1.amazonaws.com</code>みたいなことは出来ませんよということ。</p>

<p><code>サイトドメイン＝バケット名</code>にすればわかりやすいじゃん！<br/>
と思っていたらとんでも設定で痛い目に合いました。</p>

<h2>Solution</h2>

<p>バケット名にドット<code>.</code>を含めない。</p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/carrierwaveuploader/carrierwave/issues/667">[GitHub] SSL Error when access Amazon S3</a></li>
<li><a href="http://blog.dateofrock.com/2012/02/s3.html">S3のバケット名はよく考えて命名しましょう！</a></li>
</ul>


<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] inherited_resourcesによって変更された，scaffoldの挙動を元に戻す方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/29/how-to-disable-the-scaffold-behavior-that-has-changed-by-inherited_resources/"/>
    <updated>2013-07-29T11:41:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/29/how-to-disable-the-scaffold-behavior-that-has-changed-by-inherited_resources</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  activeadmin (0.6.0)
</span><span class='line'>  inherited_resources (1.4.0)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><code>active_admin</code>をインストールした後から，<code>scaffold</code>や<code>rails g controller</code>を実行すると，必ず自動生成されたコントローラが，<code>InheritedResources</code>を継承した状態になっている．
<code>inherited_resources</code>を使いたくない場面もあるので，デフォルトでこの状態になるのは好ましくない．</p>

<h3>Factor</h3>

<ul>
<li><code>active_admin</code>をインストールすると，<code>inherited_resources</code>もインストールされる．</li>
<li><code>inherited_resources</code>がデフォルトの<code>scaffold</code>の挙動を書き換える</li>
</ul>


<p>以下の<code>config.app_generators</code>の部分で，<code>:inherited_resources_controller</code>を設定している．</p>

<figure class='code'><figcaption><span>vendor/bundle/ruby/1.9.1/gems/inherited_resources-1.4.0/lib/inherited_resources.rb#L25</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Railtie</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rails</span><span class="p">:</span><span class="ss">:Engine</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">inherited_resources</span> <span class="o">=</span> <span class="no">InheritedResources</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:app_generators</span><span class="p">)</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">app_generators</span><span class="o">.</span><span class="n">scaffold_controller</span> <span class="o">=</span> <span class="ss">:inherited_resources_controller</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">scaffold_controller</span> <span class="o">=</span> <span class="ss">:inherited_resources_controller</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Solution</h2>

<ul>
<li><code>config/application.rb</code>にコードを追加する</li>
</ul>


<h2>How to</h2>

<p><code>cofig/application.rb</code>に以下のコードを追加する</p>

<figure class='code'><figcaption><span>config/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">app_generators</span><span class="o">.</span><span class="n">scaffold_controller</span> <span class="o">=</span> <span class="ss">:scaffold_controller</span> <span class="c1"># 追加</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>:scaffold_controller</code>の元ネタはどこだよということで探してみると，<br/>
<code>vendor/bundle/ruby/1.9.1/gems/railties-3.2.11/lib/rails/generators.rb</code>で見つかった．</p>

<figure class='code'><figcaption><span>vendor/bundle/ruby/1.9.1/gems/railties-3.2.11/lib/rails/generators.rb#L50</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">DEFAULT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">:rails</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>    <span class="ss">:scaffold_controller</span> <span class="o">=&gt;</span> <span class="ss">:scaffold_controller</span><span class="p">,</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>inherited_resources</code>が書き換えてるのはこの<code>DEFAULT_OPTIONS</code>の値なので，<br/>
それを元の値である<code>:scaffold_controller</code>に戻せば良い．</p>

<h3>Doubt</h3>

<h4>どうしてこの方法で<code>config</code>の値を再設定できるのか</h4>

<p>Railsの初期化の順序的に<code>config/boot.rb(load gems) -&gt; config/application.rb</code>だから．
（間違っていたら指摘してください＞＜；）</p>

<h4><code>gems</code>の中での読み込み順</h4>

<p>これって<code>inherited_resources</code>の読み込みが<code>railties</code>より先か後かで挙動が変わるのだろうか・・<br/>
この辺りの<code>Rails</code>のデフォルトの挙動を上書きする辺りがいまいちしっくりこない・・</p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/josevalim/inherited_resources/issues/195">[GitHub] any way to permit &lsquo;rails scaffold&rsquo; to work normally if inherited_resources used by another gem?</a></li>
<li><a href="http://guides.rubyonrails.org/generators.html">[RailsGuides] generators</a></li>
<li><a href="http://guides.rubyonrails.org/engines.html">[RailsGuides] engines</a></li>
</ul>


<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[powを停止させる方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/23/how-to-stop-pow/"/>
    <updated>2013-07-23T17:39:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/23/how-to-stop-pow</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>pow 0.4.1
</span><span class='line'>Anvir 1.0.2
</span><span class='line'>[Gems]
</span><span class='line'>  powder 0.2.0</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><code>Mac OSX</code>上で<code>Rails</code>の開発を行う際，<code>pow</code>を利用しているものの，<br/>
一時的に<code>Nginx</code>等のサーバを建てて使いたい場合に等に，<br/>
<code>pow</code>のプロセスを停止しておきたい．<br/>
※<code>kill</code>はしたくない・・</p>

<h2>Solution</h2>

<ul>
<li><code>Anvir</code>を使う</li>
<li><code>powder</code>を使う</li>
</ul>


<h2>How to</h2>

<h3>Anvirを使う</h3>

<p><a href="http://anvilformac.com/">こちらからAnvirをダウンロード</a>し，インストールする．<br/>
インストールするとMacのステータスバーに<code>Anvir</code>のアイコンが表示される．<br/>
アイコンをクリックすると，以下のようなミニウインドウが表示される．<br/>
矢印で示したボタンをクリックすることで，<code>pow</code>のON/OFFを切り替えることができる．</p>

<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-23-18-12-58.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-23-18-12-58.jpg" alt="Anvir メニュー" /></a></p>

<h3>powderを使う</h3>

<p>gemをインストールする</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install powder
</span></code></pre></td></tr></table></div></figure>


<p>コンソールで以下のコマンドを実行することで，<code>pow</code>のON/OFFを切り替えることができる．</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># start pow</span>
</span><span class='line'>powder up
</span><span class='line'>
</span><span class='line'><span class="c"># stop pow</span>
</span><span class='line'>powder down
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iterm2 + tmux上で，Vimの画面のズレを直す方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/16/how-to-fix-shear-in-vim-with-iterm2-and-tmux/"/>
    <updated>2013-07-16T19:14:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/16/how-to-fix-shear-in-vim-with-iterm2-and-tmux</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>Vim 7.3.923
</span><span class='line'>tmux 1.6
</span><span class='line'>iterm2 Build 1.0.0.20130624</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><code>iterm2 + tmux</code>の環境で，<code>Vim</code>を使用してファイルの保存等を行ったタイミングで画面がズレてしまう．<br/>
具体的には下のスクリーンショットのような表示になる．</p>

<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-16-20-17-10.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-16-20-17-10.jpg" alt="shear in Vim" /></a></p>

<p>ステータスライン部分が崩れて１行余計に増えているだけでなく，<br/>
編集画面全てが１行ずつズレていて，カーソルがある行を上下させるか，<br/>
<code>iterm2</code>のウインドウ最小化，ウインドウ最大化を繰り返して無理やり直すというのを繰り返していた．</p>

<h2>Solution</h2>

<p><code>Vim</code>の<code>redraw</code>機能を使う</p>

<h2>How to</h2>

<p>デフォルトのキーバインドを変更していなければ，<br/>
<code>ノーマルモード</code>で以下のキーバインドで<code>redraw</code>できます．</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">&lt;</span>C<span class="p">-</span><span class="k">l</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>もし，キーバインドを別の機能に割り当てているのであれば，<br/>
（例えばウインドウ間移動）<br/>
<code>コマンドモード</code>で以下のコマンドを叩くか，<br/>
別のキーバインドに以下のコマンドを割り振ってください．</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'># コマンドモード
</span><span class='line'><span class="p">:</span><span class="k">redraw</span><span class="p">!</span>
</span><span class='line'>
</span><span class='line'># 別のキーバインド<span class="p">(</span>ここでは<span class="p">&lt;</span>C<span class="p">-</span><span class="k">r</span><span class="p">&gt;)</span>
</span><span class='line'><span class="nb">nnoremap</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">r</span><span class="p">&gt;</span> :<span class="k">redraw</span><span class="p">!&lt;</span>CR<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>後者の場合，<code>redraw</code>と<code>redraw!</code>がありますが，<code>redraw!</code>でないと，<br/>
現在の画面を破棄しないため，今回の現象を直すことができません．</p>

<h2>References</h2>

<div class='embed tweet'><blockquote class="twitter-tweet"><p><a href="https://twitter.com/d_masuyama">@d_masuyama</a> 最大化最小化しなくても Ctrl-l (←エルです)の再描画で戻るんじゃないですかね？</p>&mdash; ɐʇnɥsɐpoʇ (@todashuta) <a href="https://twitter.com/todashuta/statuses/357059805220839424">July 16, 2013</a></blockquote>
<script async src="http://lunchub.github.io//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] CarrierWaveからAmazon S3に画像アップロードできない]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3/"/>
    <updated>2013-07-14T20:18:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  CarrierWave (0.8.0)
</span><span class='line'>  fog (1.12.1)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><a href="http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3/">CarrierWaveでアップロード先をAmazon S3に設定する方法</a>等という記事を書いておきながら，<br/>
以下のエラーが表示され，全くアップロードができない．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bad URI(is not URI?)</span></code></pre></td></tr></table></div></figure>


<h2>Solution</h2>

<p>Carrierwaveの設定(initializer)を見直す．</p>

<ul>
<li><code>fog_credentials</code>の<code>:host</code>と<code>:endpoint</code>は特に指定がない場合はコメントアウトする</li>
</ul>


<p>例えば以下の設定ファイルだとエラーで死にます．</p>

<figure class='code'><figcaption><span>config/initializer/carrierwave.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:provider</span>               <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">,</span>                           <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:aws_access_key_id</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AWS_S3_KEY_ID&quot;</span><span class="o">]</span><span class="p">,</span>            <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:aws_secret_access_key</span>  <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AWS_S3_SECRET_ACCESS_KEY&quot;</span><span class="o">]</span><span class="p">,</span> <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:region</span>                 <span class="o">=&gt;</span> <span class="s1">&#39;ap-northeast-1&#39;</span><span class="p">,</span>                <span class="c1"># optional,  defaults to &#39;us-east-1&#39;</span>
</span><span class='line'>    <span class="ss">:host</span>                   <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                              <span class="c1"># optional,  defaults to nil</span>
</span><span class='line'>    <span class="ss">:endpoint</span>               <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span>                               <span class="c1"># optional,  defaults to nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>  <span class="o">=</span> <span class="s1">&#39;myapp-carrierwave&#39;</span>                <span class="c1"># required</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_public</span>     <span class="o">=</span> <span class="kp">false</span>                              <span class="c1"># optional,  defaults to true</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cache-Control&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;max-age=82800&#39;</span><span class="p">}</span> <span class="c1"># optional,  defaults to {}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>これのどこが問題かというと，<code>fog_credentials</code>の<code>:host</code>と<code>:endpoint</code>が<code>empty string</code>であるところ，<br/>
ソースのコメントを見ると（元ソースはCarrierWaveのドキュメントから），<br/>
optionalと書いてある．<br/>
つまりここは何も書かなくても動くんだ！という認識だったのだけど，そこが甘かった．<br/>
<code>何も書かなくていい ≠ empty string</code>ということなので，ここには<code>nil</code>を指定するか，<br/>
行ごとコメントアウトしておかなければならない．</p>

<p>CarrierwaveからFogへのエラースタックを追いかけて行くと，</p>

<figure class='code'><figcaption><span>lib/fog/aws/storage.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="mi">411</span>             <span class="vi">@scheme</span>     <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:scheme</span><span class="o">]</span>      <span class="o">||</span> <span class="no">DEFAULT_SCHEME</span>
</span><span class='line'>  <span class="mi">412</span>             <span class="vi">@port</span>       <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span>        <span class="o">||</span> <span class="no">DEFAULT_SCHEME_PORT</span><span class="o">[</span><span class="vi">@scheme</span><span class="o">]</span>
</span><span class='line'>  <span class="mi">413</span>             <span class="vi">@path_style</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:path_style</span><span class="o">]</span>  <span class="o">||</span> <span class="kp">false</span>
</span><span class='line'>  <span class="mi">414</span>           <span class="k">end</span>
</span><span class='line'>  <span class="mi">415</span>
</span><span class='line'>  <span class="mi">416</span>           <span class="vi">@connection</span> <span class="o">=</span> <span class="ss">Fog</span><span class="p">:</span><span class="ss">:Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">#{</span><span class="vi">@host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@port</span><span class="si">}#{</span><span class="vi">@path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="vi">@persistent</span><span class="p">,</span>  <span class="vi">@connection_options</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">417</span>         <span class="k">end</span>
</span><span class='line'>  <span class="mi">418</span>
</span><span class='line'>  <span class="mi">419</span>         <span class="k">def</span> <span class="nf">reload</span>
</span><span class='line'>  <span class="mi">420</span>           <span class="vi">@connection</span><span class="o">.</span><span class="n">reset</span>
</span><span class='line'>  <span class="mi">421</span>         <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>options</code>で渡ってくる値が<code>nil</code>であれば<code>DEFAULT_</code>値が指定される．<br/>
しかしここで<code>empty string</code>が渡ってくると，<code>@scheme</code>等の値が<code>empty string</code>になってしまう．<br/>
その結果<code>@connection</code>の組立に失敗して，アップロード先が見つからねーと怒られるみたいです．</p>

<p>私の場合は，特にこれらの値の指定は不要だったため，<br/>
行ごとコメントアウトしたところ，うまくアップロードできるようになりました！:)</p>

<h2>References</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/15717368/uploading-image-to-s3-using-carrierwave-and-fogs-bad-uri">[Stackoverflow] uploading image to s3 using carrierwave and fogs bad uri</a></li>
<li><a href="https://github.com/carrierwaveuploader/carrierwave">[GitHub] CarrierWave</a></li>
</ul>


<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] CarrierWaveでアップロード先をAmazon S3に設定する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3/"/>
    <updated>2013-07-14T17:25:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>  CarrierWave (0.8.0)
</span><span class='line'>  fog (1.12.1)</span></code></pre></td></tr></table></div></figure>


<h2>Precondition</h2>

<ul>
<li><p><code>Amazon S3</code>を利用するためには，<code>Amazon Web Services (AWS)</code>への登録が必要です．</p>

<ul>
<li><a href="http://lunchub.github.io/blog/2013/07/13/how-to-register-for-aws/">AWSへの登録記事はこちら</a></li>
</ul>
</li>
<li><p><code>CarrierWave</code>の設定時に，<code>Amazon S3</code>のBucket情報が必要なため，Bucketが作成されていなければなりません．</p>

<ul>
<li><a href="http://lunchub.github.io/blog/2013/07/14/how-to-create-bucket-on-amazon-s3/">Amazon S3にBucketを作成する方法はこちら</a></li>
</ul>
</li>
</ul>


<h2>Issues</h2>

<p>CarrierWaveのアップロード先をAmazon S3に設定したい．</p>

<p>Herokuを使ってRailsアプリを運用しているものの, Herokuではファイルをサーバ上に保存することができないため，<br/>
画像アップロード等は別のサーバに行う必要があります．<br/>
そこで今回は，非常に低価格でクラウドストレージを扱うことのできる<code>Amazon S3</code>をアップロード先に指定しました．</p>

<h2>How to</h2>

<h3>Gemを追加する</h3>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gem &quot;fog&quot;,  &quot;~&gt; 1.3.1&quot;
</span></code></pre></td></tr></table></div></figure>


<h3>initializerを追加する</h3>

<p>ここに<code>Amazon S3</code>の情報を設定します．</p>

<figure class='code'><figcaption><span>config/initializer/carrierwave.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:provider</span>               <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">,</span>                           <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:aws_access_key_id</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AWS_S3_KEY_ID&quot;</span><span class="o">]</span><span class="p">,</span>            <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:aws_secret_access_key</span>  <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AWS_S3_SECRET_ACCESS_KEY&quot;</span><span class="o">]</span><span class="p">,</span> <span class="c1"># required</span>
</span><span class='line'>    <span class="ss">:region</span>                 <span class="o">=&gt;</span> <span class="s1">&#39;ap-northeast-1&#39;</span><span class="p">,</span>                <span class="c1"># optional,  defaults to &#39;us-east-1&#39;</span>
</span><span class='line'>    <span class="c1"># :host                   =&gt; &#39;&#39;,                              # optional,  defaults to nil</span>
</span><span class='line'>    <span class="c1"># :endpoint               =&gt; &#39;&#39;                               # optional,  defaults to nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>  <span class="o">=</span> <span class="s1">&#39;myapp-carrierwave&#39;</span>                <span class="c1"># required</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_public</span>     <span class="o">=</span> <span class="kp">false</span>                              <span class="c1"># optional,  defaults to true</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cache-Control&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;max-age=82800&#39;</span><span class="p">}</span> <span class="c1"># optional,  defaults to {}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>IDとシークレットアクセスキーは，環境変数に設定しておいたほうが良いです．

<ul>
<li>ベタ書きだとGitHubにソースコードをアップしている際等に危険です．</li>
</ul>
</li>
<li><code>:region</code>の入力は任意ですが，&#8217;tokyo&#8217;リージョンを使用している場合は変更が必要です． => <code>ap-northeast-1</code></li>
<li><code>config.fog_directory</code>はBucketの名前です．</li>
<li><code>config.fog_public</code>は<code>false</code>に設定しておくことで，Rails経由でのアクセスしか<code>Amazon S3</code>上のファイルにアクセスできなくなります．</li>
</ul>


<h3>Uploaderクラスのプロパティ値を変更する</h3>

<figure class='code'><figcaption><span>APP_ROOT_PATH/app/uploaders/image_uploader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># encoding: utf-8</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="ss">CarrierWave</span><span class="p">:</span><span class="ss">:Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1"># storage :file</span>
</span><span class='line'>  <span class="n">storage</span> <span class="ss">:fog</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p><a href="https://github.com/carrierwaveuploader/carrierwave">[GitHub] carrierwave</a></p>

<p><section class="ads"></p>

<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング" /></a></div>




<div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技" /></a></div>


<p></section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWSのアクセス情報を確認する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/14/how-to-confirm-aws-access-information/"/>
    <updated>2013-07-14T15:25:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/14/how-to-confirm-aws-access-information</id>
    <content type="html"><![CDATA[<h2>Scribble</h2>

<ul>
<li><code>AWS Management Console</code>にサインインし，ページ右上のメニューから<code>Security Credentials</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-24-27.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-24-27.jpg" alt="AWS アクセス情報確認 step1" /></a></p>

<ul>
<li><code>Access Keys</code>を開き，<code>Create New Root Key</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-42-34.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-42-34.jpg" alt="AWS アクセス情報確認 step2" /></a></p>

<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-44-10.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-15-44-10.jpg" alt="AWS アクセス情報確認 step3" /></a></p>

<ul>
<li>ポップアップウインドウが開き，キーファイルをダウンロードするよう求められるので，ダウンロードする

<ul>
<li>ここでダウンロードしないと，後からシークレットアクセスキーを確認しようと思っても出来ない</li>
<li>ダウンロードしたファイルは厳重に管理する</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-16-14-10.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-16-14-10.jpg" alt="AWS アクセス情報確認 step4" /></a></p>

<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Amazon S3にBucket（ストレージ）を作成する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/14/how-to-create-bucket-on-amazon-s3/"/>
    <updated>2013-07-14T13:24:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/14/how-to-create-bucket-on-amazon-s3</id>
    <content type="html"><![CDATA[<h2>Precondition</h2>

<p><code>Amazon S3</code>を利用するためには，<code>Amazon Web Services (AWS)</code>への登録が必要です．</p>

<p><a href="http://lunchub.github.io/blog/2013/07/13/how-to-register-for-aws/">AWSへの登録記事はこちら</a></p>

<h2>How to</h2>

<ul>
<li><p><a href="https://console.aws.amazon.com/console/home">AWS Management Console</a>にアクセスする</p></li>
<li><p><code>S3</code>を選択する</p></li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-35-24.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-35-24.jpg" alt="S3 を選択する" /></a></p>

<ul>
<li><code>Create Bucket</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-38-30.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-38-30.jpg" alt="Create Bucket Button" /></a></p>

<ul>
<li>ポップアップパネルが開くので，作成したいBucketの名前と，リージョンを選択する

<ul>
<li>ここでは<code>Tokyo</code>リージョンを選択</li>
<li><code>Create</code>をクリックする</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-40-09.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-40-09.jpg" alt="Create Bucket PopUp" /></a></p>

<ul>
<li>作成に成功すると，Bucketの一覧画面へ遷移する

<ul>
<li>今作成したBucketが表示されていることがわかる</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-45-28.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-14-13-45-28.jpg" alt="" /></a></p>

<h2>Recommended</h2>

<ul>
<li><code>Rails</code> + <code>Carrierwave</code> でアップロード先を<code>Amazon S3</code>に設定したい

<ul>
<li><a href="http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3">CarrierWaveでアップロード先をAmazon S3に設定する方法</a></li>
</ul>
</li>
</ul>


<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWSに会員登録する方法]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/13/how-to-register-for-aws/"/>
    <updated>2013-07-13T18:33:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/13/how-to-register-for-aws</id>
    <content type="html"><![CDATA[<h2>How to</h2>

<ul>
<li><a href="http://aws.amazon.com/jp/">http://aws.amazon.com/jp/</a>にアクセスする</li>
<li><code>サインアップ</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-41-34.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-41-34.jpg" alt="AWS サインアップ step1" /></a></p>

<ul>
<li>メールアドレスを入力して，新規ユーザを選択する</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-48-29.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-48-29.jpg" alt="AWS サインアップ step2" /></a></p>

<ul>
<li>ユーザ名とパスワードを入力する</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-53-14.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-18-53-14.jpg" alt="AWS サインアップ step3" /></a></p>

<ul>
<li>住所情報を入力する

<ul>
<li>しかしハマるのがここ．郵便番号を３桁で入力しないとバリデーションエラーのループから抜け出せなくなる・・・ｗ</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-04-07.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-04-07.jpg" alt="AWS サインアップ step4" /></a></p>

<ul>
<li>クレジットカード情報を入力する

<ul>
<li>請求先が先程入力した住所と同じであればラジオボタンはこのまま</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-26-31.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-26-31.jpg" alt="AWS サインアップ step5" /></a></p>

<ul>
<li>本人確認を電話で行う必要があるので，<code>Japan</code>を選択して<code>Call Me Now</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-29-20.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-29-20.jpg" alt="AWS サインアップ step6" /></a></p>

<ul>
<li><p>自動音声の電話がかかってきたら，画面に表示されている<code>PINコード</code>を電話のキーパッドで入力する</p></li>
<li><p>サクセスなんちゃらバイバイ〜と言われたら画面も自動的に切り替わるので先へ進む</p></li>
<li><p>サポートプランを選択する画面になるので，適宜選択する</p>

<ul>
<li>私は個人用途なので<code>Basic (Free)</code>を選択</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-34-54.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-34-54.jpg" alt="AWS サインアップ step7" /></a></p>

<ul>
<li>この画面が表示されれば登録は完了！

<ul>
<li><code>Your AWS Account is Ready - Get Started Now</code>といったタイトルのメールが届きます</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-37-58.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-37-58.jpg" alt="AWS サインアップ step8" /></a></p>

<h3>続けて<code>Amazon S3</code>等のサービスを追加したい場合</h3>

<ul>
<li><a href="http://aws.amazon.com/jp/">http://aws.amazon.com/jp/</a>にアクセスする</li>
<li><code>アカウント / コンソール</code>から<code>AWS Management Console</code>をクリックする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-46-17.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-46-17.jpg" alt="AWS サービス追加 step1" /></a></p>

<ul>
<li>サインイン画面に遷移するので，<code>I am a returning user and my password is</code>にチェックが入っていることを確認してパスワードを入力し，サインインする</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-49-59.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-49-59.jpg" alt="AWS サービス追加 step2" /></a></p>

<ul>
<li>以下のような管理画面が表示されるので，追加したいサービスを選択する</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-53-37.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-19-53-37.jpg" alt="AWS サービス追加 step3" /></a></p>

<h3>サービス追加の際注意すべき点</h3>

<ul>
<li>管理画面右上に表示されている<code>Global</code>というプルダウンで，リージョンの選択ができるサービス（Amazon EC2等）は，
できるだけ<code>Asia Pacific (Tokyo)</code>を選択したほうがいいと思います

<ul>
<li>リージョンとは，AWSのサーバが置かれている場所です</li>
<li>サーバとの物理的な距離が離れているほど，レスポンスが悪化するので・・</li>
</ul>
</li>
</ul>


<p><a href="http://lunchub.github.io/images/posts/2013/07/2013-07-13-20-00-11.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-13-20-00-11.jpg" alt="AWS サービス追加 注意点" /></a></p>

<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Mac] KeyCastrを全てのデスクトップで表示する]]></title>
    <link href="http://lunchub.github.io/blog/2013/07/11/how-to-show-keycastr-window-on-all-desktop-on-mac/"/>
    <updated>2013-07-11T21:11:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/07/11/how-to-show-keycastr-window-on-all-desktop-on-mac</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>KeyCastr 0.8.0</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p>最初にKeyCastrを起動したデスクトップでしか，
フローティングウインドウが表示されない．</p>

<h3>KeyCastrとは</h3>

<p>自分が入力したショートカットキーを
フローティングウインドウで表示してくれる便利アプリ．<br/>
スクリーンキャストなんかでよく使われています．<br/>
私はスクリーンキャストを撮っているわけではなく，<br/>
純粋に見た目が好きなので使っています・・ｗ</p>

<h2>Solution</h2>

<p>KeyCastrを開いているDesktop上の<code>Dock</code>から，
オプションを選択することで全てのデスクトップに
フローティングウインドウを表示させることができる．
<a href="http://lunchub.github.io/images/posts/2013/07/2013-07-11-21-29-30.jpg"><img src="http://lunchub.github.io/images/posts/2013/07/2013-07-11-21-29-30.jpg" alt="KeyCastr Option" /></a></p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/sdeken/keycastr/issues/1">[GitHub] doesn&rsquo;t play nicely with spaces (10.6)</a></li>
</ul>


<p><section class="ads">
</section></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] Rails + Unicornの環境でNew Relicにデータが送信されない]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn/"/>
    <updated>2013-06-26T18:38:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>お名前VPS
</span><span class='line'>CentOS 6.4
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>Unicorn v4.5.0</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p>前回までの記事で、</p>

<ul>
<li><a href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails/">RailsにNew Relicをインストールする</a></li>
<li><a href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos/">CeontOSにNew Relicをインストールする</a></li>
</ul>


<p>と、簡単に<code>New Relic</code>のインストールを行なってきたものの、問題が発生した。</p>

<p><code>Rails + Unicorn</code>の環境で、何時まで経っても<code>New Relic</code>にRailsのデータが送信されていないというもの。</p>

<h2>Solution</h2>

<p>これは<code>Unicorn</code>を使っている場合に発生する問題で、以下の手段で解決できます。<br/>
今回は後者の手段で解決しました。</p>

<p>なぜ<code>Unicorn</code>の<code>preload_app</code>が必要なのかは理解出来ませんでした・・</p>

<h2>How to</h2>

<h3>Unicornの設定に追記する</h3>

<p><code>RAILS_APP_ROOT/config</code>ディレクトリにある<code>Unicorn</code>の設定ファイルに以下のディレクティブを追記する。</p>

<figure class='code'><figcaption><span>unicorn.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>preload_app true
</span></code></pre></td></tr></table></div></figure>


<h3>Railsのinitializerを追加する</h3>

<p><code>RAILS_APP_ROOT/config/initializers/</code>ディレクトリに以下のファイルを追加する</p>

<figure class='code'><figcaption><span>new_relic.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Ensure the agent is started using Unicorn.</span>
</span><span class='line'><span class="c1"># This is needed when using Unicorn and preload_app is not set to true.</span>
</span><span class='line'><span class="c1"># See https://newrelic.com/docs/ruby/no-data-with-unicorn</span>
</span><span class='line'><span class="k">if</span> <span class="n">defined?</span> <span class="no">Unicorn</span>
</span><span class='line'>  <span class="o">::</span><span class="ss">NewRelic</span><span class="p">:</span><span class="ss">:Agent</span><span class="o">.</span><span class="n">manual_start</span><span class="p">()</span>
</span><span class='line'>  <span class="o">::</span><span class="ss">NewRelic</span><span class="p">:</span><span class="ss">:Agent</span><span class="o">.</span><span class="n">after_fork</span><span class="p">(</span><span class="ss">:force_reconnect</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ファイル名は何でもOKです。</p>

<h2>References</h2>

<ul>
<li><a href="https://newrelic.com/docs/ruby/no-data-with-unicorn">No Data with Unicorn</a></li>
<li><a href="http://unicorn.bogomips.org/Unicorn/Configurator.html#method-i-preload_app">Unicorn::Configurator</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CentOSにNew Relicをインストールする]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos/"/>
    <updated>2013-06-26T17:12:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>お名前VPS
</span><span class='line'>CentOS 6.4</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<ul>
<li>Railsのパフォーマンスを簡単に計測したい &ndash;> <a href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails/">Railsへの導入記事はこちら</a></li>
<li>ついでにサーバーのモニタリングもしたい</li>
<li>Muninとか自分で導入するのがめんどくさい</li>
</ul>


<h2>Solution</h2>

<p><a href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails/">前回の記事</a>に続いて、
<code>New Relic</code>をCentOSにインストールします。</p>

<p>インストール後は自動的にデータを収集してくれるので、<br/>
こちらも非常に手軽に導入できます。</p>

<h2>How to</h2>

<p>基本的に管理画面に記載されている内容そのままで導入できます。<br/>
<code>New Relic</code>にログイン後、サイドバーから<code>Servers</code>を選択し、さらに<code>RedHat or CentOS</code>を選択すると、<br/>
以下の画像のような表示になります。</p>

<p><a href="http://lunchub.github.io/images/posts/2013/06/2013-06-26-17-22-30.jpg"><img src="http://lunchub.github.io/images/posts/2013/06/2013-06-26-17-22-30.jpg" alt="newrelic admin panel image 2" /></a>
<a href="http://lunchub.github.io/images/posts/2013/06/2013-06-26-17-28-04.jpg"><img src="http://lunchub.github.io/images/posts/2013/06/2013-06-26-17-28-04.jpg" alt="newrelic admin panel image 3" /></a></p>

<p>後はこの画面の通りにコマンドを実行するだけなのですが、<br/>
気をつける点として、以下を挙げておきます。</p>

<ul>
<li>インストールは<code>root</code>ユーザで行う</li>
<li><code>yum install</code>には<code>sudo</code>をつける</li>
</ul>


<p>特に2番目でハマりました。環境依存の問題もあると思いますが、<br/>
<code>yum install</code>で<code>newrelic</code>ユーザが作成されなかったために、<br/>
<code>newrelic-sysmond start</code>が実行できませんでした。</p>

<p><code>yum install</code>で表示されていたエラー。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@tmp<span class="o">]</span><span class="c"># yum install newrelic-sysmond</span>
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'>epel/metalink                                                                                                                                                                                                          | 5.8 kB     00:00
</span><span class='line'> * base: www.ftp.ne.jp
</span><span class='line'> * epel: ftp.iij.ad.jp
</span><span class='line'> * extras: www.ftp.ne.jp
</span><span class='line'> * updates: www.ftp.ne.jp
</span><span class='line'>base                                                                                                                                                                                                                   | 3.7 kB     00:00
</span><span class='line'>epel                                                                                                                                                                                                                   | 4.2 kB     00:00
</span><span class='line'>extras                                                                                                                                                                                                                 | 3.4 kB     00:00
</span><span class='line'>newrelic                                                                                                                                                                                                               |  951 B     00:00
</span><span class='line'>newrelic/primary                                                                                                                                                                                                       | 2.1 kB     00:00
</span><span class='line'>newrelic                                                                                                                                                                                                                                  5/5
</span><span class='line'>updates                                                                                                                                                                                                                | 3.4 kB     00:00
</span><span class='line'>updates/primary_db                                                                                                                                                                                                     | 3.1 MB     00:00
</span><span class='line'>Setting up Install Process
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package newrelic-sysmond.x86_64 0:1.2.0.257-1 will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies <span class="nv">Resolved</span>
</span><span class='line'>
</span><span class='line'><span class="o">==============================================================================================================================================================================================================================================</span>
</span><span class='line'> Package                                                        Arch                                                 Version                                                     Repository                                              <span class="nv">Size</span>
</span><span class='line'><span class="o">==============================================================================================================================================================================================================================================</span>
</span><span class='line'>Installing:
</span><span class='line'> newrelic-sysmond                                               x86_64                                               1.2.0.257-1                                                 newrelic                                               1.2 M
</span><span class='line'>
</span><span class='line'>Transaction <span class="nv">Summary</span>
</span><span class='line'><span class="o">==============================================================================================================================================================================================================================================</span>
</span><span class='line'>Install       1 Package<span class="o">(</span>s<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Total download size: 1.2 M
</span><span class='line'>Installed size: 3.5 M
</span><span class='line'>Is this ok <span class="o">[</span>y/N<span class="o">]</span>: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>newrelic-sysmond-1.2.0.257-1.x86_64.rpm                                                                                                                                                                                | 1.2 MB     00:03
</span><span class='line'>warning: rpmts_HdrFromFdno: Header V3 DSA/SHA1 Signature, key ID 548c16bf: NOKEY
</span><span class='line'>Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-NewRelic
</span><span class='line'>Importing GPG key 0x548C16BF:
</span><span class='line'> Userid : New Relic &lt;support@newrelic.com&gt;
</span><span class='line'> Package: newrelic-repo-5-3.noarch <span class="o">(</span>installed<span class="o">)</span>
</span><span class='line'> From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-NewRelic
</span><span class='line'>Is this ok <span class="o">[</span>y/N<span class="o">]</span>: y
</span><span class='line'>Running rpm_check_debug
</span><span class='line'>Running Transaction Test
</span><span class='line'>Transaction Test Succeeded
</span><span class='line'>Running Transaction
</span><span class='line'>Warning: RPMDB altered outside of yum.
</span><span class='line'>  Installing : newrelic-sysmond-1.2.0.257-1.x86_64                                                                                                                                                                                        1/1
</span><span class='line'>groupadd: cannot lock /etc/group; try again later.
</span><span class='line'>useradd: group <span class="s1">&#39;newrelic&#39;</span> does not exist
</span><span class='line'>warning: group newrelic does not exist - using root
</span><span class='line'>warning: user newrelic does not exist - using root
</span><span class='line'>warning: group newrelic does not exist - using root
</span><span class='line'>chown: invalid user: <span class="sb">`</span>newrelic:newrelic<span class="err">&#39;</span>
</span><span class='line'>su: user newrelic does not exist
</span><span class='line'>  Verifying  : newrelic-sysmond-1.2.0.257-1.x86_64                                                                                                                                                                                        1/1
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  newrelic-sysmond.x86_64 0:1.2.0.257-1
</span><span class='line'>
</span><span class='line'>Complete!
</span></code></pre></td></tr></table></div></figure>


<p>全然<code>Complete!</code>してねーよ！<code>groupadd</code>失敗してるやんけ・・</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] RailsにNew Relicをインストールする]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails/"/>
    <updated>2013-06-26T16:01:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<ul>
<li>Railsのパフォーマンスを簡単に計測したい</li>
<li>ついでにサーバーのモニタリングもしたい &ndash;> <a href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos/">CentOSへの導入記事はこちら</a></li>
<li>Muninとか自分で導入するのがめんどくさい</li>
</ul>


<h2>Solution</h2>

<p><a href="https://newrelic.com/">New Relic</a>というサービスを利用する。<br/>
<code>New Relic</code>は簡単に導入が出来て、無料で使えるモニタリングサービス。<br/>
※但し無料版はログの保存期間が24時間しかない。</p>

<p>別途プラグインの導入を行うことで、サーバーのモニタリングも簡単にできます。</p>

<h2>How to</h2>

<h3><code>New Relic</code>のアカウントを取得する</h3>

<p><code>New Relic</code>のサイトで<a href="https://newrelic.com/">会員登録</a>を行う。</p>

<h3>Gemをインストールする</h3>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;newrelic_rpm&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定ファイルで<code>Environment</code>に応じたモニタリングのON/OFFができるので、<br/>
ここでは<code>production</code>グループに纏めたりしなくても良いと思います。</p>

<h3>configディレクトリに<code>newrelic.yml</code>を配置する</h3>

<p><code>newrelic.yml</code>は<code>New Relic</code>にログイン後、サイドバーから<code>Applications</code>を選択し、さらに<code>Add more</code>を選択するとダウンロード出来る画面へ遷移する。</p>

<p><a href="http://lunchub.github.io/images/posts/2013/06/2013-06-26-16-38-43.jpg"><img src="http://lunchub.github.io/images/posts/2013/06/2013-06-26-16-38-43.jpg" alt="newrelic admin panel image" /></a></p>

<p>画面遷移した後に、<code>Installation instructions for</code>で<code>Ruby</code>を選択すると、<br/>
下の画像のようにダウンロードボタンが出現する。</p>

<p><a href="http://lunchub.github.io/images/posts/2013/06/2013-06-26-16-50-31.jpg"><img src="http://lunchub.github.io/images/posts/2013/06/2013-06-26-16-50-31.jpg" alt="newrelic admin panel image" /></a></p>

<p>ダウンロードしてきた<code>newrelic.yml</code>を<code>RAILS_APP_ROOT/config</code>に配置すればOK!</p>

<h2>Tips</h2>

<p><code>newrelic.yml</code>の以下の部分を書き換えることで、<br/>
管理画面に表示されるアプリ名を変更できます。</p>

<figure class='code'><figcaption><span>newrelic.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">app_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Application</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] uninitialized constant Readline (NameError)]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror/"/>
    <updated>2013-06-20T15:56:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mac OSX 10.7.5 (Lion)
</span><span class='line'>ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
</span><span class='line'>Rails 3.2.13
</span><span class='line'>[Gems]
</span><span class='line'>rb-readline (0.5.0)
</span><span class='line'>
</span><span class='line'>debugger (1.3.1)
</span><span class='line'>  columnize (&gt;= 0.3.1)
</span><span class='line'>  debugger-linecache (~&gt; 1.1.1)
</span><span class='line'>  debugger-ruby_core_source (~&gt; 1.1.8)
</span><span class='line'>debugger-linecache (1.1.2)
</span><span class='line'>  debugger-ruby_core_source (&gt;= 1.1.1)
</span><span class='line'>debugger-ruby_core_source (1.1.9)</span></code></pre></td></tr></table></div></figure>


<h2>Issues</h2>

<p><code>rails c</code>しようとすると、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>uninitialized constant Debugger::LocalInterface::Readline <span class="o">(</span>NameError<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>と表示されてコンソールに入れなくなっていた。</p>

<p>エラー内容から、<code>debugger</code>の問題を疑い、<code>Gemfile</code>から外してみる。<br/>
すると今度は<code>pry</code>が<code>Debugger</code>の部分だけ<code>Pry</code>に変わった同じエラーが出力される。<br/>
そこで<code>pry</code>を<code>Gemfile</code>から外し・・・ｒｙ</p>

<p>これを繰り返しても同じエラーが続く・・・<br/>
どうやら共通して<code>readline</code>辺りに問題があるらしい。</p>

<p>システムに<code>readline</code>がインストールされていないのかと思ったが、<br/>
<code>homebrew</code>でちゃんとインストールしてある・・</p>

<p><code>Gemfile</code>を眺めていると、<code>rb-readline</code>なるものが追加されている。<br/>
どうやらこいつが怪しい・・・</p>

<h2>Solution</h2>

<p>で、解決策は2つ</p>

<ul>
<li><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</li>
<li><code>rb-readline</code>を削除する（）</li>
</ul>


<p>問題は<code>rb-readline</code>が<code>0.5.0</code>からシステム上の<code>readline</code>を<code>remove_const</code>しちゃうこと。<br/>
どうもこのgemはC言語で実装された<code>readline</code>とは別に、<br/>
Rubyだけで完結させようって主旨なのかな？<br/>
それで既に<code>readline</code>があると再定義の警告が出るんで、<br/>
一度<code>remove_const</code>しちゃうぜってことらしい。<br/>
しかし他のgemのエラーからして、明らかにシステム上に<code>readline</code>があることを期待している気がする・・。<br/>
これってどうなんだろう・・。<br/>
一応<code>Readline</code>を呼んでいる部分を全て<code>RbReadline</code>に置換すれば動くっぽいけど・・ｗ</p>

<h3><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</h3>

<p>前述の<code>remove_const</code>が入るのはバージョン<code>0.5.0</code>から。<br/>
なので、この変更が入る前の<code>0.4.2</code>にしてあげればエラーはなくなる。</p>

<h3><code>rb-readline</code>を削除する（）</h3>

<p>こちらはシステム上に<code>readline</code>がインストールされていて、<br/>
かつRubyのビルドオプションで<code>--with-readline</code>をつけてビルドしている場合に有効。
システム上の<code>readline</code>を使ってくれるので<code>rb-readline</code>は不要になります。</p>

<p>ちなみにMacなら</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install readline
</span><span class='line'><span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">&quot;--disable-install-doc --with-readline-dir=$(brew --prefix readline)&quot;</span> rbenv install <span class="nv">$VERSION</span>
</span></code></pre></td></tr></table></div></figure>


<p>でビルドしなおせばOK!<br/>
<code>$VERSION</code>はお好みで。</p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/luislavena/rb-readline/commit/d8b49a061eeb710c47bc92cc610e8f489c4fd447">[GitHub] Unload Readline before loading rb-readline</a></li>
<li><a href="http://stackoverflow.com/questions/16288331/rails-3-uninitialized-constant-irbreadlineinputmethodreadline-nameerror-i">[stackoverflow] Rails 3: uninitialized constant IRB::ReadlineInputMethod::Readline (NameError) in Heroku</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
