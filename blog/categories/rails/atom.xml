<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Rails | function Blog() {};]]></title>
  <link href="http://lunchub.github.io/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://lunchub.github.io/"/>
  <updated>2013-07-11T21:59:45+09:00</updated>
  <id>http://lunchub.github.io/</id>
  <author>
    <name><![CDATA[Daisuke Masuyama]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails + Unicornの環境でNew Relicにデータが送信されない]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn/"/>
    <updated>2013-06-26T18:38:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<p><code>
お名前VPS
CentOS 6.4
ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
Rails 3.2.13
Unicorn v4.5.0
</code></p>

<h2>Issues</h2>

<p>前回までの記事で、</p>

<ul>
<li><a href="/blog/2013/06/26/installing-new-relic-to-rails/">RailsにNew Relicをインストールする</a></li>
<li><a href="/blog/2013/06/26/installing-new-relic-to-centos/">CeontOSにNew Relicをインストールする</a></li>
</ul>


<p>と、簡単に<code>New Relic</code>のインストールを行なってきたものの、問題が発生した。</p>

<p><code>Rails + Unicorn</code>の環境で、何時まで経っても<code>New Relic</code>にRailsのデータが送信されていないというもの。</p>

<h2>Solution</h2>

<p>これは<code>Unicorn</code>を使っている場合に発生する問題で、以下の手段で解決できます。<br/>
今回は後者の手段で解決しました。</p>

<p>なぜ<code>Unicorn</code>の<code>preload_app</code>が必要なのかは理解出来ませんでした・・</p>

<h2>How to</h2>

<h3>Unicornの設定に追記する</h3>

<p><code>RAILS_APP_ROOT/config</code>ディレクトリにある<code>Unicorn</code>の設定ファイルに以下のディレクティブを追記する。
<code>text unicorn.rb
preload_app true
</code></p>

<h3>Railsのinitializerを追加する</h3>

<p><code>RAILS_APP_ROOT/config/initializers/</code>ディレクトリに以下のファイルを追加する
``` ruby new_relic.rb</p>

<h1>Ensure the agent is started using Unicorn.</h1>

<h1>This is needed when using Unicorn and preload_app is not set to true.</h1>

<h1>See <a href="https://newrelic.com/docs/ruby/no-data-with-unicorn">https://newrelic.com/docs/ruby/no-data-with-unicorn</a></h1>

<p>if defined? Unicorn
  ::NewRelic::Agent.manual_start()
  ::NewRelic::Agent.after_fork(:force_reconnect => true)
end
```
ファイル名は何でもOKです。</p>

<h2>References</h2>

<ul>
<li><a href="https://newrelic.com/docs/ruby/no-data-with-unicorn">No Data with Unicorn</a></li>
<li><a href="http://unicorn.bogomips.org/Unicorn/Configurator.html#method-i-preload_app">Unicorn::Configurator</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CentOSにNew Relicをインストールする]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos/"/>
    <updated>2013-06-26T17:12:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-centos</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<p><code>
お名前VPS
CentOS 6.4
</code></p>

<h2>Issues</h2>

<ul>
<li>Railsのパフォーマンスを簡単に計測したい &ndash;> <a href="/blog/2013/06/26/installing-new-relic-to-rails/">Railsへの導入記事はこちら</a></li>
<li>ついでにサーバーのモニタリングもしたい</li>
<li>Muninとか自分で導入するのがめんどくさい</li>
</ul>


<h2>Solution</h2>

<p><a href="/blog/2013/06/26/installing-new-relic-to-rails/">前回の記事</a>に続いて、
<code>New Relic</code>をCentOSにインストールします。</p>

<p>インストール後は自動的にデータを収集してくれるので、<br/>
こちらも非常に手軽に導入できます。</p>

<h2>How to</h2>

<p>基本的に管理画面に記載されている内容そのままで導入できます。<br/>
<code>New Relic</code>にログイン後、サイドバーから<code>Servers</code>を選択し、さらに<code>RedHat or CentOS</code>を選択すると、<br/>
以下の画像のような表示になります。</p>

<p><a href="/images/posts/2013/06/2013-06-26-17-22-30.jpg"><img src="/images/posts/2013/06/2013-06-26-17-22-30.jpg" alt="newrelic admin panel image 2" /></a>
<a href="/images/posts/2013/06/2013-06-26-17-28-04.jpg"><img src="/images/posts/2013/06/2013-06-26-17-28-04.jpg" alt="newrelic admin panel image 3" /></a></p>

<p>後はこの画面の通りにコマンドを実行するだけなのですが、<br/>
気をつける点として、以下を挙げておきます。</p>

<ul>
<li>インストールは<code>root</code>ユーザで行う</li>
<li><code>yum install</code>には<code>sudo</code>をつける</li>
</ul>


<p>特に2番目でハマりました。環境依存の問題もあると思いますが、<br/>
<code>yum install</code>で<code>newrelic</code>ユーザが作成されなかったために、<br/>
<code>newrelic-sysmond start</code>が実行できませんでした。</p>

<p><code>yum install</code>で表示されていたエラー。
``` bash
[root@tmp]# yum install newrelic-sysmond
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
epel/metalink                                                                                                                                                                                                          | 5.8 kB     00:00
 * base: www.ftp.ne.jp
 * epel: ftp.iij.ad.jp
 * extras: www.ftp.ne.jp
 * updates: www.ftp.ne.jp
base                                                                                                                                                                                                                   | 3.7 kB     00:00
epel                                                                                                                                                                                                                   | 4.2 kB     00:00
extras                                                                                                                                                                                                                 | 3.4 kB     00:00
newrelic                                                                                                                                                                                                               |  951 B     00:00
newrelic/primary                                                                                                                                                                                                       | 2.1 kB     00:00
newrelic                                                                                                                                                                                                                                  5/5
updates                                                                                                                                                                                                                | 3.4 kB     00:00
updates/primary_db                                                                                                                                                                                                     | 3.1 MB     00:00
Setting up Install Process
Resolving Dependencies
&mdash;> Running transaction check
&mdash;&ndash;> Package newrelic-sysmond.x86_64 0:1.2.0.257-1 will be installed
&mdash;> Finished Dependency Resolution</p>

<p>Dependencies Resolved</p>

<p>==============================================================================================================================================================================================================================================</p>

<h1> Package                                                        Arch                                                 Version                                                     Repository                                              Size</h1>

<p>Installing:
 newrelic-sysmond                                               x86_64                                               1.2.0.257-1                                                 newrelic                                               1.2 M</p>

<h1>Transaction Summary</h1>

<p>Install       1 Package(s)</p>

<p>Total download size: 1.2 M
Installed size: 3.5 M
Is this ok [y/N]: y
Downloading Packages:
newrelic-sysmond-1.2.0.257-1.x86_64.rpm                                                                                                                                                                                | 1.2 MB     00:03
warning: rpmts_HdrFromFdno: Header V3 DSA/SHA1 Signature, key ID 548c16bf: NOKEY
Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-NewRelic
Importing GPG key 0x548C16BF:
 Userid : New Relic <a href="&#x6d;&#x61;&#105;&#x6c;&#116;&#x6f;&#58;&#x73;&#x75;&#x70;&#x70;&#x6f;&#114;&#116;&#64;&#x6e;&#101;&#x77;&#x72;&#101;&#108;&#105;&#99;&#46;&#99;&#x6f;&#109;">&#115;&#x75;&#x70;&#112;&#111;&#114;&#x74;&#x40;&#110;&#101;&#119;&#114;&#x65;&#x6c;&#x69;&#99;&#46;&#x63;&#111;&#x6d;</a>
 Package: newrelic-repo-5-3.noarch (installed)
 From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-NewRelic
Is this ok [y/N]: y
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
Warning: RPMDB altered outside of yum.
  Installing : newrelic-sysmond-1.2.0.257-1.x86_64                                                                                                                                                                                        1/1
groupadd: cannot lock /etc/group; try again later.
useradd: group &lsquo;newrelic&rsquo; does not exist
warning: group newrelic does not exist &ndash; using root
warning: user newrelic does not exist &ndash; using root
warning: group newrelic does not exist &ndash; using root
chown: invalid user: `newrelic:newrelic'
su: user newrelic does not exist
  Verifying  : newrelic-sysmond-1.2.0.257-1.x86_64                                                                                                                                                                                        1/1</p>

<p>Installed:
  newrelic-sysmond.x86_64 0:1.2.0.257-1</p>

<p>Complete!
```</p>

<p>全然<code>Complete!</code>してねーよ！<code>groupadd</code>失敗してるやんけ・・</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RailsにNew Relicをインストールする]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails/"/>
    <updated>2013-06-26T16:01:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/26/installing-new-relic-to-rails</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<p><code>
ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
Rails 3.2.13
</code></p>

<h2>Issues</h2>

<ul>
<li>Railsのパフォーマンスを簡単に計測したい</li>
<li>ついでにサーバーのモニタリングもしたい &ndash;> <a href="/blog/2013/06/26/installing-new-relic-to-centos/">CentOSへの導入記事はこちら</a></li>
<li>Muninとか自分で導入するのがめんどくさい</li>
</ul>


<h2>Solution</h2>

<p><a href="https://newrelic.com/">New Relic</a>というサービスを利用する。<br/>
<code>New Relic</code>は簡単に導入が出来て、無料で使えるモニタリングサービス。<br/>
※但し無料版はログの保存期間が24時間しかない。</p>

<p>別途プラグインの導入を行うことで、サーバーのモニタリングも簡単にできます。</p>

<h2>How to</h2>

<h3><code>New Relic</code>のアカウントを取得する</h3>

<p><code>New Relic</code>のサイトで<a href="https://newrelic.com/">会員登録</a>を行う。</p>

<h3>Gemをインストールする</h3>

<p><code>ruby Gemfile
gem 'newrelic_rpm'
</code>
設定ファイルで<code>Environment</code>に応じたモニタリングのON/OFFができるので、<br/>
ここでは<code>production</code>グループに纏めたりしなくても良いと思います。</p>

<h3>configディレクトリに<code>newrelic.yml</code>を配置する</h3>

<p><code>newrelic.yml</code>は<code>New Relic</code>にログイン後、サイドバーから<code>Applications</code>を選択し、さらに<code>Add more</code>を選択するとダウンロード出来る画面へ遷移する。</p>

<p><a href="/images/posts/2013/06/2013-06-26-16-38-43.jpg"><img src="/images/posts/2013/06/2013-06-26-16-38-43.jpg" alt="newrelic admin panel image" /></a></p>

<p>画面遷移した後に、<code>Installation instructions for</code>で<code>Ruby</code>を選択すると、<br/>
下の画像のようにダウンロードボタンが出現する。</p>

<p><a href="/images/posts/2013/06/2013-06-26-16-50-31.jpg"><img src="/images/posts/2013/06/2013-06-26-16-50-31.jpg" alt="newrelic admin panel image" /></a></p>

<p>ダウンロードしてきた<code>newrelic.yml</code>を<code>RAILS_APP_ROOT/config</code>に配置すればOK!</p>

<h2>Tips</h2>

<p><code>newrelic.yml</code>の以下の部分を書き換えることで、<br/>
管理画面に表示されるアプリ名を変更できます。
<code>yaml newrelic.yml
app_name: My Application
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[uninitialized constant Readline (NameError)]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror/"/>
    <updated>2013-06-20T15:56:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<p>```
Mac OSX 10.7.5 (Lion)
ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
Rails 3.2.13
[Gems]
rb-readline (0.5.0)</p>

<p>debugger (1.3.1)
  columnize (>= 0.3.1)
  debugger-linecache (~> 1.1.1)
  debugger-ruby_core_source (~> 1.1.8)
debugger-linecache (1.1.2)
  debugger-ruby_core_source (>= 1.1.1)
debugger-ruby_core_source (1.1.9)
```</p>

<h2>Issues</h2>

<p><code>rails c</code>しようとすると、
<code>bash
uninitialized constant Debugger::LocalInterface::Readline (NameError)
</code>
と表示されてコンソールに入れなくなっていた。</p>

<p>エラー内容から、<code>debugger</code>の問題を疑い、<code>Gemfile</code>から外してみる。<br/>
すると今度は<code>pry</code>が<code>Debugger</code>の部分だけ<code>Pry</code>に変わった同じエラーが出力される。<br/>
そこで<code>pry</code>を<code>Gemfile</code>から外し・・・ｒｙ</p>

<p>これを繰り返しても同じエラーが続く・・・<br/>
どうやら共通して<code>readline</code>辺りに問題があるらしい。</p>

<p>システムに<code>readline</code>がインストールされていないのかと思ったが、<br/>
<code>homebrew</code>でちゃんとインストールしてある・・</p>

<p><code>Gemfile</code>を眺めていると、<code>rb-readline</code>なるものが追加されている。<br/>
どうやらこいつが怪しい・・・</p>

<h2>Solution</h2>

<p>で、解決策は2つ</p>

<ul>
<li><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</li>
<li><code>rb-readline</code>を削除する（）</li>
</ul>


<p>問題は<code>rb-readline</code>が<code>0.5.0</code>からシステム上の<code>readline</code>を<code>remove_const</code>しちゃうこと。<br/>
どうもこのgemはC言語で実装された<code>readline</code>とは別に、<br/>
Rubyだけで完結させようって主旨なのかな？<br/>
それで既に<code>readline</code>があると再定義の警告が出るんで、<br/>
一度<code>remove_const</code>しちゃうぜってことらしい。<br/>
しかし他のgemのエラーからして、明らかにシステム上に<code>readline</code>があることを期待している気がする・・。<br/>
これってどうなんだろう・・。<br/>
一応<code>Readline</code>を呼んでいる部分を全て<code>RbReadline</code>に置換すれば動くっぽいけど・・ｗ</p>

<h3><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</h3>

<p>前述の<code>remove_const</code>が入るのはバージョン<code>0.5.0</code>から。<br/>
なので、この変更が入る前の<code>0.4.2</code>にしてあげればエラーはなくなる。</p>

<h3><code>rb-readline</code>を削除する（）</h3>

<p>こちらはシステム上に<code>readline</code>がインストールされていて、<br/>
かつRubyのビルドオプションで<code>--with-readline</code>をつけてビルドしている場合に有効。
システム上の<code>readline</code>を使ってくれるので<code>rb-readline</code>は不要になります。</p>

<p>ちなみにMacなら
<code>
brew install readline
CONFIGURE_OPTS="--disable-install-doc --with-readline-dir=$(brew --prefix readline)" rbenv install $VERSION
</code>
でビルドしなおせばOK!<br/>
<code>$VERSION</code>はお好みで。</p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/luislavena/rb-readline/commit/d8b49a061eeb710c47bc92cc610e8f489c4fd447">[GitHub] Unload Readline before loading rb-readline</a></li>
<li><a href="http://stackoverflow.com/questions/16288331/rails-3-uninitialized-constant-irbreadlineinputmethodreadline-nameerror-i">[stackoverflow] Rails 3: uninitialized constant IRB::ReadlineInputMethod::Readline (NameError) in Heroku</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Rails] ActiveAdminのインストールと初期設定でハマったこと]]></title>
    <link href="http://lunchub.github.io/blog/2013/06/17/hamari-install-activeadmin-gem-to-rails/"/>
    <updated>2013-06-17T12:43:00+09:00</updated>
    <id>http://lunchub.github.io/blog/2013/06/17/hamari-install-activeadmin-gem-to-rails</id>
    <content type="html"><![CDATA[<h2>Environment</h2>

<p><code>
Mac OSX 10.7.5 (Lion)
ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2]
Rails 3.2.13
[gems]
jquery-rails (3.0.1)
jquery-ui-rails (4.0.3)
activeadmin (0.6.0)
</code></p>

<h2>Issues</h2>

<p>手っ取り早く管理画面を設置したくて<code>activeadmin</code>をインストールしたところ、<br/>
初っ端からコケまくった。</p>

<h3>&ldquo;uninitialized constant DashboardController&rdquo;</h3>

<p><code>rails g active_admin:install</code>してとりあえず見るかーと、<br/>
トップページアクセスしたら出るエラー。</p>

<h3>&ldquo;couldn&rsquo;t find file &lsquo;jquery-ui&rsquo;&rdquo;</h3>

<p><code>jQuery UI</code>が見つからないエラー。<br/>
いや、gemでバッチリ指定して入れてるのに・・・<br/>
こっちがだいぶハマった。</p>

<h2>Solution</h2>

<h3>&ldquo;uninitialized constant DashboardController&rdquo;</h3>

<p>これは<code>routes.rb</code>の書き方が問題らしい。</p>

<p><code>activeadmin</code>をインストールすると、<code>routes.rb</code>に以下のコードが追加されるのだけど、</p>

<p><code>ruby routes.rb
devise_for :admin_users, ActiveAdmin::Devise.config
ActiveAdmin.routes(self)
</code></p>

<p>これが<code>routes.rb</code>の中で、rootパスより前にあるとダメらしい・・ｗ<br/>
なので、rootパスの記述を上記コードより上に持ってくればOK。</p>

<p>``` ruby routes.rb
root :to => &lsquo;index#index&rsquo;</p>

<p>devise_for :admin_users, ActiveAdmin::Devise.config
ActiveAdmin.routes(self)
```</p>

<h3>&ldquo;couldn&rsquo;t find file &lsquo;jquery-ui&rsquo;&rdquo;</h3>

<p>問題は、</p>

<ul>
<li><code>activeadmin</code>が<code>jQuery</code>と<code>jQuery UI</code>を使用する</li>
<li><code>jquery-rails, 3.0.0</code>から<code>jQuery UI</code>が切り離された</li>
<li><code>activeadmin</code>の<code>application.js</code>内で<code>jQuery UI</code>の呼び方が間違っている</li>
</ul>


<h4><code>activeadmin</code>が<code>jQuery</code>と<code>jQuery UI</code>を使用する</h4>

<p>独自に<code>application.js</code>から<code>jQuery</code>と<code>jQuery UI</code>を呼んでいる</p>

<h4><code>jquery-rails, 3.0.0</code>から<code>jQuery UI</code>が切り離された</h4>

<p>フォルダに存在しないものをimportしようとして見つかりませんエラーのパターン。<br/>
エラーメッセージでググるとほぼこれに当たる。<br/>
そして解決策が<code>jquery-rails</code>のバージョンを<code>2.3.0</code>に下げろというもの。<br/>
要するに<code>jQuery UI</code>が切り離される前のバージョンにしろってことなんだけど、<br/>
自分の場合はこれではうまくいかなかった。</p>

<h4><code>activeadmin</code>の<code>application.js</code>内で<code>jQuery UI</code>の呼び方が間違っている</h4>

<p>結局自分の場合はこれが問題だった。<br/>
下のソースを見ると、<code>jquery-ui</code>を呼んでいるのだけど、<br/>
これだと名前が解決できないようで、呼び出せない。
``` js /path/to/rails_app/vendor/bundle/ruby/1.9.1/gems/activeadmin-0.6.0/app/assets/javascripts/active_admin/base.js
//= require jquery
//= require jquery-ui
//= require jquery_ujs</p>

<p>//= require active_admin/application
```</p>

<p>そこで、<code>jquery-ui-rails</code>の<a href="https://github.com/joliss/jquery-ui-rails">Githubドキュメント</a>を読むと、
``` text
To require all jQuery UI modules,  add the following to your application.js:</p>

<p>//= require jquery.ui.all
```
と書いてある。
先程とは呼び方が異なっている。</p>

<p>なので、Gemのassetsの中身を直接書き換え、以下のように変更したところ動くようになった。
``` js /path/to/rails_app/vendor/bundle/ruby/1.9.1/gems/activeadmin-0.6.0/app/assets/javascripts/active_admin/base.js
//= require jquery
//= require jquery.ui.all
//= require jquery_ujs</p>

<p>//= require active_admin/application
```</p>

<h2>モンキーパッチの当て方がわかりませんorz</h2>

<p>上記の<code>jQuery UI</code>を呼び出す方法を変更する修正だけど、<br/>
直接Gemのファイルいじるのは間違いなくバッドノウハウのはず。<br/>
だからモンキーパッチを当てておきたいのだけど、<br/>
ググって出てくる方法はクラスをオーバーライドするものばかりで、<br/>
assetsの中身を書き換えたい場合はどうすればいいんだろう？<br/>
誰か知っていたら教えて下さい＞＜；</p>

<h2>References</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/15818446/active-admin-ruby-on-rails-dashboard-controller-error">Active Admin Ruby on rails Dashboard Controller Error</a></li>
<li><a href="https://github.com/joliss/jquery-ui-rails">[Gem] jquery-ui-rails</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
