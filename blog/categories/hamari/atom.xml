<?xml version="1.0" encoding="utf-8"?> <feed xmlns="http://www.w3.org/2005/Atom"><title><![CDATA[Category: Hamari | function Blog() {};]]></title><link href="http://lunchub.github.io/blog/categories/hamari/atom.xml" rel="self"/><link href="http://lunchub.github.io/"/> <updated>2013-07-29T17:30:47+09:00</updated> <id>http://lunchub.github.io/</id> <author> <name><![CDATA[Daisuke Masuyama]]></name> </author> <generator uri="http://octopress.org/">Octopress</generator> <entry><title type="html"><![CDATA[Amazon S3のバケット名に"."ドットを含めるとハマる]]></title><link href="http://lunchub.github.io/blog/2013/07/29/hamari-on-s3-bucket-name-with-dots/"/> <updated>2013-07-29T17:05:00+09:00</updated> <id>http://lunchub.github.io/blog/2013/07/29/hamari-on-s3-bucket-name-with-dots</id> <content type="html"><![CDATA[<h2>Precondition</h2><ul><li><a href="http://lunchub.github.io/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3/">CarrierWaveでアップロード先をAmazon S3に設定する方法</a></li><li><a href="http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3/">CarrierWaveからAmazon S3に画像アップロードできない</a></li></ul><h2>Issues</h2><p><code>carrierwave</code> + <code>fog</code>で<code>Amazon S3</code>に画像をアップロードできようになったのはいいものの、<br/> いざ画面に<code>Amazon S3</code>上の画像を表示させようとすると、<br/> 画像が表示されない。</p><h3>Factor</h3><p>バケット名にドット<code>.</code>が含まれていることで、SSLエラーが発生している。<br/> <code>Amazon S3</code>のSSL証明書がワイルドカード<code>*.s3-ap-northeast-1.amazonaws.com</code>だから。<br/> これはレベル3ドメインまでの範囲で、ワイルドカードを使っていいよということなので、<br/> <code>mysite.com.s3-ap-northeast-1.amazonaws.com</code>みたいなことは出来ませんよということ。</p><p><code>サイトドメイン＝バケット名</code>にすればわかりやすいじゃん！<br/> と思っていたらとんでも設定で痛い目に合いました。</p><h2>Solution</h2><p>バケット名にドット<code>.</code>を含めない。</p><h2>References</h2><ul><li><a href="https://github.com/carrierwaveuploader/carrierwave/issues/667">[GitHub] SSL Error when access Amazon S3</a></li><li><a href="http://blog.dateofrock.com/2012/02/s3.html">S3のバケット名はよく考えて命名しましょう！</a></li></ul><p><section class="ads"> </section></p> ]]></content> </entry> <entry><title type="html"><![CDATA[CarrierWaveからAmazon S3に画像アップロードできない]]></title><link href="http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3/"/> <updated>2013-07-14T20:18:00+09:00</updated> <id>http://lunchub.github.io/blog/2013/07/14/hamari-on-carrierwave-with-amazon-s3</id> <content type="html"><![CDATA[<h2>Environment</h2><p><code> Mac OSX 10.7.5 (Lion) ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2] Rails 3.2.13 [Gems] CarrierWave (0.8.0) fog (1.12.1) </code></p><h2>Issues</h2><p><a href="/blog/2013/07/14/how-to-use-carrierwave-with-amazon-s3/">CarrierWaveでアップロード先をAmazon S3に設定する方法</a>等という記事を書いておきながら，<br/> 以下のエラーが表示され，全くアップロードができない．</p><p><code> bad URI(is not URI?) </code></p><h2>Solution</h2><p>Carrierwaveの設定(initializer)を見直す．</p><ul><li><code>fog_credentials</code>の<code>:host</code>と<code>:endpoint</code>は特に指定がない場合はコメントアウトする</li></ul><p>例えば以下の設定ファイルだとエラーで死にます．</p><p>``` ruby config/initializer/carrierwave.rb CarrierWave.configure do |config| config.fog_credentials = {</p><pre><code>:provider               =&gt; 'AWS',                           # required
:aws_access_key_id      =&gt; ENV["AWS_S3_KEY_ID"],            # required
:aws_secret_access_key  =&gt; ENV["AWS_S3_SECRET_ACCESS_KEY"], # required
:region                 =&gt; 'ap-northeast-1',                # optional,  defaults to 'us-east-1'
:host                   =&gt; '',                              # optional,  defaults to nil
:endpoint               =&gt; ''                               # optional,  defaults to nil
</code></pre><p> } config.fog_directory = ‘myapp-carrierwave’ # required config.fog_public = false # optional, defaults to true config.fog_attributes = {‘Cache-Control’=>‘max-age=82800’} # optional, defaults to {} end ```</p><p>これのどこが問題かというと，<code>fog_credentials</code>の<code>:host</code>と<code>:endpoint</code>が<code>empty string</code>であるところ，<br/> ソースのコメントを見ると（元ソースはCarrierWaveのドキュメントから），<br/> optionalと書いてある．<br/> つまりここは何も書かなくても動くんだ！という認識だったのだけど，そこが甘かった．<br/> <code>何も書かなくていい ≠ empty string</code>ということなので，ここには<code>nil</code>を指定するか，<br/> 行ごとコメントアウトしておかなければならない．</p><p>CarrierwaveからFogへのエラースタックを追いかけて行くと，</p><p><code>ruby lib/fog/aws/storage.rb 411 @scheme = options[:scheme] || DEFAULT_SCHEME 412 @port = options[:port] || DEFAULT_SCHEME_PORT[@scheme] 413 @path_style = options[:path_style] || false 414 end 415 416 @connection = Fog::Connection.new("#{@scheme}://#{@host}:#{@port}#{@path}", @persistent, @connection_options) 417 end 418 419 def reload 420 @connection.reset 421 end </code></p><p><code>options</code>で渡ってくる値が<code>nil</code>であれば<code>DEFAULT_</code>値が指定される．<br/> しかしここで<code>empty string</code>が渡ってくると，<code>@scheme</code>等の値が<code>empty string</code>になってしまう．<br/> その結果<code>@connection</code>の組立に失敗して，アップロード先が見つからねーと怒られるみたいです．</p><p>私の場合は，特にこれらの値の指定は不要だったため，<br/> 行ごとコメントアウトしたところ，うまくアップロードできるようになりました！:)</p><h2>References</h2><ul><li><a href="http://stackoverflow.com/questions/15717368/uploading-image-to-s3-using-carrierwave-and-fogs-bad-uri">[Stackoverflow] uploading image to s3 using carrierwave and fogs bad uri</a></li><li><a href="https://github.com/carrierwaveuploader/carrierwave">[GitHub] CarrierWave</a></li></ul><p><section class="ads"><div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774146633/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51%2BUj1CI5tL._SX280_CR0,0,280,230_.jpg" alt="Ruby on Rails 3 アプリケーションプログラミング"/></a></div><div class="amzimg"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797363827/lunchub-22/" rel="nofollow" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hvKPIWmdL._SX280_CR2,75,278,230_.jpg" alt="Rails3レシピブック 190の技"/></a></div></section></p> ]]></content> </entry> <entry><title type="html"><![CDATA[Rails + Unicornの環境でNew Relicにデータが送信されない]]></title><link href="http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn/"/> <updated>2013-06-26T18:38:00+09:00</updated> <id>http://lunchub.github.io/blog/2013/06/26/hamari-on-installing-new-relic-to-rails-with-unicorn</id> <content type="html"><![CDATA[<h2>Environment</h2><p><code> お名前VPS CentOS 6.4 ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2] Rails 3.2.13 Unicorn v4.5.0 </code></p><h2>Issues</h2><p>前回までの記事で、</p><ul><li><a href="/blog/2013/06/26/installing-new-relic-to-rails/">RailsにNew Relicをインストールする</a></li><li><a href="/blog/2013/06/26/installing-new-relic-to-centos/">CeontOSにNew Relicをインストールする</a></li></ul><p>と、簡単に<code>New Relic</code>のインストールを行なってきたものの、問題が発生した。</p><p><code>Rails + Unicorn</code>の環境で、何時まで経っても<code>New Relic</code>にRailsのデータが送信されていないというもの。</p><h2>Solution</h2><p>これは<code>Unicorn</code>を使っている場合に発生する問題で、以下の手段で解決できます。<br/> 今回は後者の手段で解決しました。</p><p>なぜ<code>Unicorn</code>の<code>preload_app</code>が必要なのかは理解出来ませんでした・・</p><h2>How to</h2><h3>Unicornの設定に追記する</h3><p><code>RAILS_APP_ROOT/config</code>ディレクトリにある<code>Unicorn</code>の設定ファイルに以下のディレクティブを追記する。 <code>text unicorn.rb preload_app true </code></p><h3>Railsのinitializerを追加する</h3><p><code>RAILS_APP_ROOT/config/initializers/</code>ディレクトリに以下のファイルを追加する ``` ruby new_relic.rb</p><h1>Ensure the agent is started using Unicorn.</h1><h1>This is needed when using Unicorn and preload_app is not set to true.</h1><h1>See <a href="https://newrelic.com/docs/ruby/no-data-with-unicorn">https://newrelic.com/docs/ruby/no-data-with-unicorn</a></h1><p>if defined? Unicorn ::NewRelic::Agent.manual_start() ::NewRelic::Agent.after_fork(:force_reconnect => true) end ``` ファイル名は何でもOKです。</p><h2>References</h2><ul><li><a href="https://newrelic.com/docs/ruby/no-data-with-unicorn">No Data with Unicorn</a></li><li><a href="http://unicorn.bogomips.org/Unicorn/Configurator.html#method-i-preload_app">Unicorn::Configurator</a></li></ul>]]></content> </entry> <entry><title type="html"><![CDATA[uninitialized constant Readline (NameError)]]></title><link href="http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror/"/> <updated>2013-06-20T15:56:00+09:00</updated> <id>http://lunchub.github.io/blog/2013/06/20/uninitialized-constant-readline-nameerror</id> <content type="html"><![CDATA[<h2>Environment</h2><p>``` Mac OSX 10.7.5 (Lion) ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2] Rails 3.2.13 [Gems] rb-readline (0.5.0)</p><p>debugger (1.3.1) columnize (>= 0.3.1) debugger-linecache (~> 1.1.1) debugger-ruby_core_source (~> 1.1.8) debugger-linecache (1.1.2) debugger-ruby_core_source (>= 1.1.1) debugger-ruby_core_source (1.1.9) ```</p><h2>Issues</h2><p><code>rails c</code>しようとすると、 <code>bash uninitialized constant Debugger::LocalInterface::Readline (NameError) </code> と表示されてコンソールに入れなくなっていた。</p><p>エラー内容から、<code>debugger</code>の問題を疑い、<code>Gemfile</code>から外してみる。<br/> すると今度は<code>pry</code>が<code>Debugger</code>の部分だけ<code>Pry</code>に変わった同じエラーが出力される。<br/> そこで<code>pry</code>を<code>Gemfile</code>から外し・・・ｒｙ</p><p>これを繰り返しても同じエラーが続く・・・<br/> どうやら共通して<code>readline</code>辺りに問題があるらしい。</p><p>システムに<code>readline</code>がインストールされていないのかと思ったが、<br/> <code>homebrew</code>でちゃんとインストールしてある・・</p><p><code>Gemfile</code>を眺めていると、<code>rb-readline</code>なるものが追加されている。<br/> どうやらこいつが怪しい・・・</p><h2>Solution</h2><p>で、解決策は2つ</p><ul><li><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</li><li><code>rb-readline</code>を削除する（）</li></ul><p>問題は<code>rb-readline</code>が<code>0.5.0</code>からシステム上の<code>readline</code>を<code>remove_const</code>しちゃうこと。<br/> どうもこのgemはC言語で実装された<code>readline</code>とは別に、<br/> Rubyだけで完結させようって主旨なのかな？<br/> それで既に<code>readline</code>があると再定義の警告が出るんで、<br/> 一度<code>remove_const</code>しちゃうぜってことらしい。<br/> しかし他のgemのエラーからして、明らかにシステム上に<code>readline</code>があることを期待している気がする・・。<br/> これってどうなんだろう・・。<br/> 一応<code>Readline</code>を呼んでいる部分を全て<code>RbReadline</code>に置換すれば動くっぽいけど・・ｗ</p><h3><code>rb-readline</code>のバージョン指定を<code>'~&gt; 0.4.2'</code>にする</h3><p>前述の<code>remove_const</code>が入るのはバージョン<code>0.5.0</code>から。<br/> なので、この変更が入る前の<code>0.4.2</code>にしてあげればエラーはなくなる。</p><h3><code>rb-readline</code>を削除する（）</h3><p>こちらはシステム上に<code>readline</code>がインストールされていて、<br/> かつRubyのビルドオプションで<code>--with-readline</code>をつけてビルドしている場合に有効。 システム上の<code>readline</code>を使ってくれるので<code>rb-readline</code>は不要になります。</p><p>ちなみにMacなら <code> brew install readline CONFIGURE_OPTS="--disable-install-doc --with-readline-dir=$(brew --prefix readline)" rbenv install $VERSION </code> でビルドしなおせばOK!<br/> <code>$VERSION</code>はお好みで。</p><h2>References</h2><ul><li><a href="https://github.com/luislavena/rb-readline/commit/d8b49a061eeb710c47bc92cc610e8f489c4fd447">[GitHub] Unload Readline before loading rb-readline</a></li><li><a href="http://stackoverflow.com/questions/16288331/rails-3-uninitialized-constant-irbreadlineinputmethodreadline-nameerror-i">[stackoverflow] Rails 3: uninitialized constant IRB::ReadlineInputMethod::Readline (NameError) in Heroku</a></li></ul>]]></content> </entry> <entry><title type="html"><![CDATA[[Rails] ActiveAdminのインストールと初期設定でハマったこと]]></title><link href="http://lunchub.github.io/blog/2013/06/17/hamari-install-activeadmin-gem-to-rails/"/> <updated>2013-06-17T12:43:00+09:00</updated> <id>http://lunchub.github.io/blog/2013/06/17/hamari-install-activeadmin-gem-to-rails</id> <content type="html"><![CDATA[<h2>Environment</h2><p><code> Mac OSX 10.7.5 (Lion) ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin11.4.2] Rails 3.2.13 [gems] jquery-rails (3.0.1) jquery-ui-rails (4.0.3) activeadmin (0.6.0) </code></p><h2>Issues</h2><p>手っ取り早く管理画面を設置したくて<code>activeadmin</code>をインストールしたところ、<br/> 初っ端からコケまくった。</p><h3>“uninitialized constant DashboardController”</h3><p><code>rails g active_admin:install</code>してとりあえず見るかーと、<br/> トップページアクセスしたら出るエラー。</p><h3>“couldn’t find file ‘jquery-ui’”</h3><p><code>jQuery UI</code>が見つからないエラー。<br/> いや、gemでバッチリ指定して入れてるのに・・・<br/> こっちがだいぶハマった。</p><h2>Solution</h2><h3>“uninitialized constant DashboardController”</h3><p>これは<code>routes.rb</code>の書き方が問題らしい。</p><p><code>activeadmin</code>をインストールすると、<code>routes.rb</code>に以下のコードが追加されるのだけど、</p><p><code>ruby routes.rb devise_for :admin_users, ActiveAdmin::Devise.config ActiveAdmin.routes(self) </code></p><p>これが<code>routes.rb</code>の中で、rootパスより前にあるとダメらしい・・ｗ<br/> なので、rootパスの記述を上記コードより上に持ってくればOK。</p><p>``` ruby routes.rb root :to => ‘index#index’</p><p>devise_for :admin_users, ActiveAdmin::Devise.config ActiveAdmin.routes(self) ```</p><h3>“couldn’t find file ‘jquery-ui’”</h3><p>問題は、</p><ul><li><code>activeadmin</code>が<code>jQuery</code>と<code>jQuery UI</code>を使用する</li><li><code>jquery-rails, 3.0.0</code>から<code>jQuery UI</code>が切り離された</li><li><code>activeadmin</code>の<code>application.js</code>内で<code>jQuery UI</code>の呼び方が間違っている</li></ul><h4><code>activeadmin</code>が<code>jQuery</code>と<code>jQuery UI</code>を使用する</h4><p>独自に<code>application.js</code>から<code>jQuery</code>と<code>jQuery UI</code>を呼んでいる</p><h4><code>jquery-rails, 3.0.0</code>から<code>jQuery UI</code>が切り離された</h4><p>フォルダに存在しないものをimportしようとして見つかりませんエラーのパターン。<br/> エラーメッセージでググるとほぼこれに当たる。<br/> そして解決策が<code>jquery-rails</code>のバージョンを<code>2.3.0</code>に下げろというもの。<br/> 要するに<code>jQuery UI</code>が切り離される前のバージョンにしろってことなんだけど、<br/> 自分の場合はこれではうまくいかなかった。</p><h4><code>activeadmin</code>の<code>application.js</code>内で<code>jQuery UI</code>の呼び方が間違っている</h4><p>結局自分の場合はこれが問題だった。<br/> 下のソースを見ると、<code>jquery-ui</code>を呼んでいるのだけど、<br/> これだと名前が解決できないようで、呼び出せない。 ``` js /path/to/rails_app/vendor/bundle/ruby/1.9.1/gems/activeadmin-0.6.0/app/assets/javascripts/active_admin/base.js //= require jquery //= require jquery-ui //= require jquery_ujs</p><p>//= require active_admin/application ```</p><p>そこで、<code>jquery-ui-rails</code>の<a href="https://github.com/joliss/jquery-ui-rails">Githubドキュメント</a>を読むと、 ``` text To require all jQuery UI modules, add the following to your application.js:</p><p>//= require jquery.ui.all ``` と書いてある。 先程とは呼び方が異なっている。</p><p>なので、Gemのassetsの中身を直接書き換え、以下のように変更したところ動くようになった。 ``` js /path/to/rails_app/vendor/bundle/ruby/1.9.1/gems/activeadmin-0.6.0/app/assets/javascripts/active_admin/base.js //= require jquery //= require jquery.ui.all //= require jquery_ujs</p><p>//= require active_admin/application ```</p><h2>モンキーパッチの当て方がわかりませんorz</h2><p>上記の<code>jQuery UI</code>を呼び出す方法を変更する修正だけど、<br/> 直接Gemのファイルいじるのは間違いなくバッドノウハウのはず。<br/> だからモンキーパッチを当てておきたいのだけど、<br/> ググって出てくる方法はクラスをオーバーライドするものばかりで、<br/> assetsの中身を書き換えたい場合はどうすればいいんだろう？<br/> 誰か知っていたら教えて下さい＞＜；</p><h2>References</h2><ul><li><a href="http://stackoverflow.com/questions/15818446/active-admin-ruby-on-rails-dashboard-controller-error">Active Admin Ruby on rails Dashboard Controller Error</a></li><li><a href="https://github.com/joliss/jquery-ui-rails">[Gem] jquery-ui-rails</a></li></ul>]]></content> </entry> </feed>